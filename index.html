<!DOCTYPE html>

<html lang="it">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Sankey Visualization</title>
		<link rel="stylesheet" href="css/jquery-ui.css">
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="css/bootstrap-select.min.css">
		<link href="css/tipsy.css" rel="stylesheet" type="text/css" />
		

	</head>
	<body>
		<div class="container-fluid">
				<div class="page-header text-center">
					<h1>Grid of Points - Sankey Visualization</h1>      
				</div>
		</div>
		 
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-2 col-lg-2">
					<h3>Collection:</h3>
					<select class="selectpicker form-control" id="collection">
						<option>TREC_T07</option>
						<option>TREC_T08</option>
						<option>TREC_T09</option>
						<option>TREC_T10</option>
					<!--<option>TREC_T13</option>-->
						<option>TREC_T14</option>
						<option>TREC_T15</option>
					</select>
				</div>

				<div class="col-md-2 col-lg-2">
					<h3>Measure:</h3>
				<!--	<label class="radio-inline">
						<input class="restriction" type="radio" name="inlineRadioOptions2" id="inlineRadio3" value="normal" checked> normal
					</label>
					<label class="radio-inline">
						<input class="restriction" type="radio" name="inlineRadioOptions2" id="inlineRadio4" value="minmax"> min-max
					</label> -->
					<select class="selectpicker form-control" id="measure">
						<option>ap</option>
					<!--<option>map</option>-->
						<option>rbp</option>
						<option>p10</option>
						<option>ndcg</option>
						<option>twist</option>
						<option>err</option>
					</select>
				</div>

				<div class="col-md-1 col-lg-1" id="radiomeas">
					<div class="min-spacer"></div>
					<label class="radio-inline">
						<input class="restriction" type="radio" name="RadioOptions2" id="Radio3" value="tbt"> topic-by-topic
					</label><br>
					<label class="radio-inline">
						<input class="restriction" type="radio" name="RadioOptions2" id="Radio4" value="average" checked> mean
					</label>
				</div>

				<div class="col-md-2 col-lg-2 invisible" id="topic_form">
					<h3>Topic:</h3>
					<select class="selectpicker form-control" data-live-search="true" data-size="5" id="topic">						
						
					</select>
				</div>

				<div class="col-md-1 col-lg-1" id="normalization">
					<h3>Scaling:</h3>
				<!--	<label class="radio-inline">
						<input class="restriction" type="radio" name="inlineRadioOptions2" id="inlineRadio3" value="normal" checked> normal
					</label>
					<label class="radio-inline">
						<input class="restriction" type="radio" name="inlineRadioOptions2" id="inlineRadio4" value="minmax"> min-max
					</label> -->
					<!--<button type="button" class="btn-xs btn-default pull-right" id="prova" style="vertical-align:center" onclick= "normalization(precision_active_nodes, precision_nodes, true)">Select All
						</button>-->
					<label class="checkbox-inline"><input id="norm" class="normalizebox" type="checkbox" value="minmax">min-max</label>
					<!--<label class="checkbox-inline"><input class="normalizebox" type="checkbox" value="min" unchecked>max</label>-->
				</div>
				

			</div>
			<hr>
			<div id="sortable">
				<div class="row ui-state-default" id="stoplist" position=1>
					
					<div class="col-md-12 col-lg-12" id="stoplist">
						
						<h3><small><span class="glyphicon glyphicon-resize-vertical"></span></small>Stoplist:
						<button type="button" class="btn-xs btn-default pull-right" id="select-all-stoplist" style="vertical-align:center" onclick= "selectAll('stoplist',true, true)">Select All
						</button>
						<button type="button" class="btn-xs btn-default pull-right align-bottom" id="select-all-stoplist" style="vertical-align:bottom" onclick= "selectAll('stoplist',false, true)">Deselect All
						</button></h3>
					</div>	
					
					<div class="col-md-12 col-lg-12" id="stoplist">	
						<label class="checkbox-inline"><input id="checkbox_vis" class="stoplistbox" type="checkbox" value="indri" checked>indri</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="stoplistbox" type="checkbox" value="lucene" checked>lucene</label>
						<label class="checkbox-inline"><input id="checkbox_vis"  class="stoplistbox" type="checkbox" value="nostop" checked>nostop</label>
						<label class="checkbox-inline"><input id="checkbox_vis"  class="stoplistbox" type="checkbox" value="smart" checked>smart</label>
						<label class="checkbox-inline"><input id="checkbox_vis"  class="stoplistbox" type="checkbox" value="snowball" checked>snowball</label>
						<label class="checkbox-inline"><input id="checkbox_vis"  class="stoplistbox" type="checkbox" value="terrier" checked>terrier</label>
					</div>
					<div class="spacer"></div>
				</div>
				
				<div class="row ui-state-default" id="stemmer" position=2>
					<div class="col-md-12 col-lg-12" id="stemmer">
						
						<h3><small><span class="glyphicon glyphicon-resize-vertical"></span></small>Stemmer:
						<button type="button" class="btn-xs btn-default pull-right" id="select-all-stemmer" style="vertical-align:center" onclick= "selectAll('stemmer',true, true)">Select All
						</button>
						<button type="button" class="btn-xs btn-default pull-right" id="deselect-all-stemmer" style="vertical-align:bottom" onclick= "selectAll('stemmer',false, true)">Deselect All
						</button></h3>
						
					</div>
					
					<div class="col-md-12 col-lg-12" id="stemmer">	
						<label class="checkbox-inline"><input id="checkbox_vis"  class="stemmerbox" type="checkbox" value="krovetz" checked>krovetz</label>
						<label class="checkbox-inline"><input id="checkbox_vis"  class="stemmerbox" type="checkbox" value="lovins" checked>lovins</label>
						<label class="checkbox-inline"><input id="checkbox_vis"  class="stemmerbox" type="checkbox" value="nolug" checked>nolug</label>
						<label class="checkbox-inline"><input id="checkbox_vis"  class="stemmerbox" type="checkbox" value="porter" checked>porter</label>
						<label class="checkbox-inline"><input id="checkbox_vis"  class="stemmerbox" type="checkbox" value="snowballPorter" checked>snowballPorter</label>
						<label class="checkbox-inline"><input id="checkbox_vis"  class="stemmerbox" type="checkbox" value="weakPorter" checked>weakPorter</label>
					</div>
					<div class="spacer"></div>
				</div>

				<div class="row ui-state-default" id="model" position=3>
					
					<div class="col-md-12 col-lg-12" id="model">
						<h3><small><span class="glyphicon glyphicon-resize-vertical"></span></small>Model:
						<button type="button" class="btn-xs btn-default pull-right" id="select-all-model" style="vertical-align:center" onclick= "selectAll('model',true, true)">Select All
						</button>
						<button type="button" class="btn-xs btn-default pull-right" id="deselect-all-model" style="vertical-align:bottom" onclick= "selectAll('model',false, true)">Deselect All
						</button></h3>
					</div><!--<span class="whitespace"></span>-->
				
					<div class="col-md-12 col-lg-12" id="model">
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="bb2" checked>bb2</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="bm25" checked>bm25</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="dfiz" checked>dfiz</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="dfree" checked>dfree</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="dirichletlm" checked>dirichletlm</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="dlh" checked>dlh</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="dph" checked>dph</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="hiemstralm" checked>hiemstralm</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="ifb2" checked>ifb2</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="inb2" checked>inb2</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="inexpb2" checked>inexpb2</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="inl2" checked>inl2</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="jskls" checked>jskls</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="lemurtfidf" checked>lemurtfidf</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="lgd" checked>lgd</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="pl2" checked>pl2</label>
						<label class="checkbox-inline"><input id="checkbox_vis" class="modelbox" type="checkbox" value="tfidf" checked>tfidf</label>

					</div>
					<div class="spacer"></div>
				</div>
			</div>

			
			<!--<div class="row">
				<div class="col-md-12" id="selection">			
					<button type="button" id="selectAll" class="btn-lg btn-default">Select All</button>
				</div>
			</div>-->
		</div>
		<div class="loader show" id="loader"></div>
		<div class="container-fluid">
			<div class="row">
				
				<div class="col-md-7 col-lg-7">
					<h3>Legend:</h3>
					<div id = "legends"  style="height: 30px;">
					</div>
				</div>


				<div class="col-md-4 col-lg-4">
					<h3>Link Settings:</h3>
					<div class = "row">
						<div class="col-md-2">Color:</div>
						<div class="col-md-10" id ="linkColor">
							<label class="radio-inline">
								<input class="colorSelection" type="radio" name="RadioOptions1" id="Radio1" value="node-based" checked> node-based
							</label>
							<label class="radio-inline">
								<input class="colorSelection" type="radio" name="RadioOptions1" id="Radio2" value="average"> final-value-based
							</label>
						</div>
					</div>
					<div class = "row">
						<div class="col-md-2">Curves?</div>
						<div class="col-md-10" id = "curvature">
							<label class="radio-inline">
								<input class="curvSetting" type="radio" name="RadioOptions3" id="Radio5" value="curve" checked> Yes!
							<label class="radio-inline">
								<input class="curvSetting" type="radio" name="RadioOptions3" id="Radio6" value="straight"> No, thanks
							</label>
						</div>
					</div>		
				</div>

				<div class="col-md-1 col-lg-1" id="deselectNodes">
						<div class="min-spacer"></div>
						<button type="button" class="btn-md btn-default" id="prova" style="vertical-align:center" onclick= "resetSelection()">Reset Selection
						</button>
				</div>

			<div>
			<div class="row">
				<div class="col-md-12 col-lg-12" id="sankey">
					<h2> Results: </h2>
					
				<div>
			</div>
			<div class="row">
				<div class="col-md-2 col-lg-2 text-left" id="title1">
						<h4>Stoplist</h4>
					</div>
					<div class="col-md-4 col-lg-4 text-center" id="title2">
						<h4>Stemmer</h4>
					</div>
					<div class="col-md-4 col-lg-4 text-center" id="title3">
						<h4>Model</h4>
					</div>
					<div class="col-md-2 col-lg-2 text-right" id="title4">
						<h4>Ap Value</h4>
					</div>
				</div>
			
			<div class="row">
				<div id="chart"  class="col-md-12 col-lg-12 svg-container">
					
					<!--<p id="chart">-->
						<!--<div class="progress">
							<div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
								<span class="sr-only">0% Complete</span>
							</div>
						</div>-->
				</div>
			</div>

			<div class="row">
				<div id="plot"  class="col-md-12 col-lg-12">
					
					<!--<p id="chart">-->
						<!--<div class="progress">
							<div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
								<span class="sr-only">0% Complete</span>
							</div>
						</div>-->
				</div>
			</div>
			
		</div>

		<!--<div class="container-fluid">
				<div class="row">
					<div class="col-md-12 col-lg-12" id="legends">
						
						
					<div>
				</div>
		</div>	-->	
			
		

		<footer class="footer">
			
			<div class="container">
			
				<div class="row">
					
					<div class="col-md-12 text-center">
						
							University of Padua - Department of Information Engineering - Credits: Giacomo Rocco and Gianmaria Silvello
					</div>
					
				
				</div>
			</div>
		</footer>
		
		
		<!-- Jquery -->
		<script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
		<script src="js/jquery-ui.js"></script>
		<script type="text/javascript" src="js/jquery.tipsy.js"></script>
		<!-- Bootstrap -->
		<script type="text/javascript" src="js/bootstrap.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-select.min.js"></script>
		<!-- Underscore -->
		<script type="text/javascript" src="js/underscore-min.js"></script>
		
		<!-- d3 -->
		<script type="text/javascript" src="js/d3.v3.js"></script>
		<script src="js/d3-color.v1.min.js"></script>
		<script src="js/d3-interpolate.v1.min.js"></script>
		<script src="js/d3-scale-chromatic.v1.min.js"></script>
		<!--<script src="js/d3-transition.v1.min.js"></script>-->
		<script src="js/d3-tooltips.js"></script>


		<!--<script type="text/javascript" src="js/priority-queue.min.js"></script>-->
		<script type="text/javascript" src="js/sankey.js"></script>
		
		<script id="sankey_script">

			var colorScheme = {
				"indri" : "rgb(255,76,190)",//d3.interpolateYlOrRd(0.60),
				"nostop" : "rgb(255,178,227)",//d3.interpolateYlOrRd(0.30),
				"lucene" : "rgb(255,127,209)",//d3.interpolateYlOrRd(0.40),
				"smart" : "rgb(255,51,181)",//d3.interpolateYlOrRd(0.70),
				"snowball" : "rgb(255,102,200)",// d3.interpolateYlOrRd(0.50),
				"terrier" : "rgb(255,25,172)",//d3.interpolateYlOrRd(0.85),
				
				"porter" : "rgb(204, 255, 51)",//d3.interpolateGreens(0.40),
				"nolug" : "rgb(236, 255, 179)",//d3.interpolateGreens(0.15),
				"lovins" : "rgb(172, 230, 0)",//d3.interpolateGreens(0.70),
				"weakPorter" : "rgb(217, 255, 102)",//d3.interpolateGreens(0.30),
				"snowballPorter" : "rgb(191, 255, 0)",//d3.interpolateGreens(0.50),
				"krovetz" : "rgb(223, 255, 128)",//d3.interpolateGreens(0.60),

				"bm25" : d3.interpolateBlues(0.85),
				"bb2" : d3.interpolateBlues(0.08),
				"dfiz" : d3.interpolateBlues(0.16),
				"dfree" : d3.interpolateBlues(0.24),
				"dirichletlm" : d3.interpolatePurples(0.40),
				"dlh" : d3.interpolateBlues(0.32),
				"dph" : d3.interpolateBlues(0.40),
				"hiemstralm": d3.interpolatePurples(0.50),
				"ifb2" : d3.interpolateBlues(0.48),
				"inb2" : d3.interpolateBlues(0.56),
				"inl2" : d3.interpolateBlues(0.64),
				"inexpb2" : d3.interpolateBlues(0.72),
				"jskls": d3.interpolatePurples(0.60),
				"lemurtfidf" : "rgb(0, 230, 230)",//d3.interpolateReds(0.55),
				"lgd" : d3.interpolatePurples(0.7),
				"pl2" : d3.interpolateBlues(0.80),
				"tfidf" : "rgb(128, 255, 255)"//d3.interpolateReds(0.45)
			}

			var colorArrayStop = [ 
				["nostop", "rgb(255,178,227)"],//d3.interpolateYlOrRd(0.30)],
				["lucene", "rgb(255,127,209)"],//d3.interpolateYlOrRd(0.40)],				
				["snowball", "rgb(255,102,200)"],//d3.interpolateYlOrRd(0.50)],
				["indri", "rgb(255,76,190)"],//d3.interpolateYlOrRd(0.60)],
				["smart", "rgb(255,51,181)"],//d3.interpolateYlOrRd(0.70)],
				["terrier", "rgb(255,25,172)"]];//d3.interpolateYlOrRd(0.85)]];

			var colorArrayStem = [ 					
				["nolug", "rgb(236, 255, 179)"],//d3.interpolateGreens(0.15)],
				["krovetz", "rgb(223, 255, 128)"],//d3.interpolateGreens(0.30)],				
				["weakPorter", "rgb(217, 255, 102)"],//d3.interpolateGreens(0.40)],
				["porter", "rgb(204, 255, 51)"],//d3.interpolateGreens(0.50)],
				["snowballPorter", "rgb(191, 255, 0)"],//d3.interpolateGreens(0.60)],				
				["lovins", "rgb(172, 230, 0)"]];//d3.interpolateGreens(0.70)]];

			var colorArrayVectorModel = [
				["tfidf", "rgb(128, 255, 255)"],//d3.interpolateReds(0.45)], 
				["lemurtfidf", "rgb(0, 230, 230)"]];//d3.interpolateReds(0.55)]];
				
			var colorArrayLanguageModel = [	
				["dirichletlm", d3.interpolatePurples(0.40)],
				["hiemstralm", d3.interpolatePurples(0.50)],
				["jskls", d3.interpolatePurples(0.60)],
				["lgd", d3.interpolatePurples(0.70)]];

			var colorArrayProbModel = [		
				["bb2", d3.interpolateBlues(0.08)],
				["dfiz", d3.interpolateBlues(0.16)],
				["dfree", d3.interpolateBlues(0.24)],			
				["dlh", d3.interpolateBlues(0.32)],
				["dph", d3.interpolateBlues(0.40)],				
				["ifb2", d3.interpolateBlues(0.48)],
				["inb2", d3.interpolateBlues(0.56)],
				["inl2", d3.interpolateBlues(0.64)],
				["inexpb2", d3.interpolateBlues(0.72)],			
				["pl2", d3.interpolateBlues(0.80)],
				["bm25", d3.interpolateBlues(0.85)]];

			var tipLegend = d3.tip()
					.attr('class', 'd3-tip d3-tip-nodes')
					.direction("s")
					//.rootElement(document.getElementById('chart'))
					.offset([10, 10])
					.html(function(d) {return d[0]});
				
			//console.log(colorScheme);
			var sizeDivLegendWidth = +$("#legends").width();
			var sizeDivLegendHeight = +$("#legends").height();
				
			var svg_legends = d3.select("#legends").append("svg")
				.attr("id", "legend_svg")
				.attr("width", 750) //sizeDivLegendWidth
				//.attr("height", sizeDivLegendHeight)
				//.attr("preserveAspectRatio", "xMinYMin meet")
				//.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+ 100)
				.classed("svg-content", true)
				.append("g")
				.attr("transform", 
						"translate(" + 15 + "," + 40 + ")")
				.call(tipLegend);
				
				//.attr("width", width + margin.left + margin.right)
				//.attr("height", height + margin.top + margin.bottom)


			svg_legends.append("g").selectAll("rect")
					.data(colorArrayStop)
					.enter()
					.append("rect")
					.attr("class","colorLegStop")
					.attr("id", function(d,i){return "colorLegStop"+i;})
					.attr("name1", function(d){return d[0];})
					.attr("height",10)
					.attr("width", 10)
					.attr("y", 30)
					.attr("x", function(d,i){ return 10+(10*i)})
					.attr("stroke", "black")
					.attr("stroke-width",0.5)
					.attr("fill",function (d){return d[1];})
					.on('mouseover', tipLegend.show)
					.on('mouseout', tipLegend.hide);

			svg_legends.append("line")
					.attr("x1", 0)                         
					.attr("y1", 10)
					.attr("x2", 0)
					.attr("y2", 45)
					.attr("stroke-width", 1)
					.attr("stroke", "white");

			svg_legends//.select("#colorLegStop"+(colorArrayStop.length-1))
					.append("text")
					.attr("x", 10)
					.attr("y", 20)
					.attr("font-size", "14px")
					.attr("fill", "white")
					.attr("text-anchor", "start")
					.attr("transform", null)
					.text("Stoplist");
					

			//console.log(prova);

			svg_legends.append("g").selectAll("rect")
					.data(colorArrayStem)
					.enter()
					.append("rect")
					.attr("class","colorLegStem")
					.attr("id", function(d,i){return "colorLegStem"+i;})
					.attr("name1", function(d){return d[0];})
					.attr("height",10)
					.attr("width", 10)
					.attr("y", 30)
					.attr("x", function(d,i){ return 90+(10*i)})
					.attr("stroke", "black")
					.attr("stroke-width",0.5)
					.attr("fill",function (d){return d[1];})
					.on('mouseover', tipLegend.show)
					.on('mouseout', tipLegend.hide);
			
			svg_legends.append("line")
					.attr("x1", 80)                         
					.attr("y1", 10)
					.attr("x2", 80)
					.attr("y2", 45)
					.attr("stroke-width", 1)
					.attr("stroke", "white");

			svg_legends//.select("#colorLegStop"+(colorArrayStop.length-1))
					.append("text")
					.attr("x", 90)
					.attr("y", 20)
					.attr("font-size", "14px")
					.attr("fill", "white")
					.attr("text-anchor", "start")
					.attr("transform", null)
					.text("Stemmer");

			svg_legends.append("line")
					.attr("x1", 160)                         
					.attr("y1", 10)
					.attr("x2", 160)
					.attr("y2", 45)
					.attr("stroke-width", 1)
					.attr("stroke", "white");

			svg_legends//.select("#colorLegStop"+(colorArrayStop.length-1))
					.append("text")
					.attr("x", 170)
					.attr("y", 20)
					.attr("font-size", "14px")
					.attr("fill", "white")
					.attr("text-anchor", "start")
					.attr("transform", null)
					.text("Model");

			svg_legends//.select("#colorLegStop"+(colorArrayStop.length-1))
					.append("text")
					.attr("x", 210)
					.attr("y", 40)
					.attr("font-size", "11px")
					.attr("fill", "white")
					.attr("text-anchor", "start")
					.attr("transform", null)
					.text("Vector Space Models");

			svg_legends.append("g").selectAll("rect")
					.data(colorArrayVectorModel)
					.enter()
					.append("rect")
					.attr("class","colorLegVectorModel")
					.attr("id", function(d,i){return "colorLegVectorModel"+i;})
					.attr("name1", function(d){return d[0];})
					.attr("height",10)
					.attr("width", 10)
					.attr("y", 30)
					.attr("x", function(d,i){ return 180+(10*i)})
					.attr("stroke", "black")
					.attr("stroke-width",0.5)
					.attr("fill",function (d){return d[1];})
					.on('mouseover', tipLegend.show)
					.on('mouseout', tipLegend.hide);

			svg_legends//.select("#colorLegStop"+(colorArrayStop.length-1))
					.append("text")
					.attr("x", 380)
					.attr("y", 40)
					.attr("font-size", "11px")
					.attr("fill", "white")
					.attr("text-anchor", "start")
					.attr("transform", null)
					.text("Language Models");

			svg_legends.append("g").selectAll("rect")
					.data(colorArrayLanguageModel)
					.enter()
					.append("rect")
					.attr("class","colorLegLanguageModel")
					.attr("id", function(d,i){return "colorLegLanguageModel"+i;})
					.attr("name1", function(d){return d[0];})
					.attr("height",10)
					.attr("width", 10)
					.attr("y", 30)
					.attr("x", function(d,i){ return 330+(10*i)})
					.attr("stroke", "black")
					.attr("stroke-width",0.5)
					.attr("fill",function (d){return d[1];})
					.on('mouseover', tipLegend.show)
					.on('mouseout', tipLegend.hide);
			
			svg_legends//.select("#colorLegStop"+(colorArrayStop.length-1))
				.append("text")
				.attr("x", 605)
				.attr("y", 40)
				.attr("font-size", "11px")
				.attr("fill", "white")
				.attr("text-anchor", "start")
				.attr("transform", null)
				.text("Probabilistic Models");

			svg_legends.append("line")
					.attr("x1", 715)                         
					.attr("y1", 10)
					.attr("x2", 715)
					.attr("y2", 45)
					.attr("stroke-width", 1)
					.attr("stroke", "white");

			svg_legends.append("g").selectAll("rect")
					.data(colorArrayProbModel)
					.enter()
					.append("rect")
					.attr("class","colorLegProbModel")
					.attr("id", function(d,i){return "colorLegProbModel"+i;})
					.attr("name1", function(d){return d[0];})
					.attr("height",10)
					.attr("width", 10)
					.attr("y", 30)
					.attr("x", function(d,i){ return 485+(10*i)})
					.attr("stroke", "black")
					.attr("stroke-width",0.5)
					.attr("fill",function (d){return d[1];})
					.on('mouseover', tipLegend.show)
					.on('mouseout', tipLegend.hide);

			var qTable;
			d3.csv("data/qtable005Dunnett.csv", function(data) {
				qTable = data;
				
			});

			$( function() {

				var $sortableList = $( "#sortable" );
				$sortableList.sortable();

				var actualval = [];
				$sortableList.children().toArray().forEach(function(element)
				{
					actualval.push(element.id);

				});
				


				//var linkOrderData = $( "#sortable" ).sortable('serialize');
				//$( "#sortable" ).disableSelection();
				var sortEventHandler = function(event, ui){
					console.log("New sort order!");
					$('#normalization input').each(function(){
						$(this).prop('checked', false);
					//console.log($(this).prop('checked', val));
					//console.log(this);
					});

					
					
					var listElements = $sortableList.children().toArray();

					//console.log(listElements); 

					var listValues = [];
					var i = 1;
					listElements.forEach(function(element){
						//console.log(element.attributes[2]);
						element.attributes[2].value = ""+i;
						listValues.push(element.id);
						//console.log(element);
						i++;
						//console.log(element.innerHTML);
					});

					//se non ho cambiato posizionamento, non fare nulla.
					if(actualval[0]==listValues[0] && actualval[1]==listValues[1])
					{
						return;
					}

					$('#Radio1').prop('checked', true);
					

					$('#Radio5').prop('checked', true);

					actualval=listValues;
					//var selected_nodes = d3.selectAll("[node-selected='1']")[0];

					//console.log(selected_nodes);
					show();

					//selectAll("stemmer", true, false);
					//selectAll("stoplist", true, false);
					//selectAll("model", true, false);


					d3.select("#sankey_svg").remove();
					//$('#chart').html('');

					generateSankey();
					
	
				}

				$sortableList.sortable({
					stop: sortEventHandler,
					placeholder: "ui-state-highlight"
				});

				

				//console.log(listValues);
				//console.log(linkOrderData);
			} );



			function topic_setup()
			{
				var meas = selectedMeasure();
				if(meas != "ndcg")
				{
					$("#title4").html("<h4>"+ meas[0].toUpperCase() + meas.substring(1) + " Value</h4>");
					$('#topic_form').removeClass('invisible').addClass('visible');
				}
				else
				{
					$("#title4").html("<h4>nDCG Value</h4>");
					$('#topic_form').removeClass('invisible').addClass('visible');
				}
				$('#chart').html('');
				
				var trec_selected = document.getElementById("collection");
				var chosen_trec = trec_selected.options[trec_selected.selectedIndex].text;
				var i = 1;
				$('#topic').html('');
				if(chosen_trec == "TREC_T07")
				{
					while(i<=50)
					{
						$('#topic').append('<option>'+(350+i)+'</option>');
						i++;
					}
					$('.selectpicker').selectpicker('refresh');
				}
				else if(chosen_trec == "TREC_T08")
				{
					while(i<=50)
					{
						$('#topic').append('<option>'+(400+i)+'</option>');
						i++;
					}
					$('.selectpicker').selectpicker('refresh');
				}
				else if(chosen_trec == "TREC_T09")
				{
					while(i<=50)
					{
						$('#topic').append('<option>'+(450+i)+'</option>');
						i++;
					}
					$('.selectpicker').selectpicker('refresh');
				}
				else if(chosen_trec == "TREC_T10")
				{
					while(i<=50)
					{
						$('#topic').append('<option>'+(500+i)+'</option>');
						i++;
					}
					$('.selectpicker').selectpicker('refresh');
				}
				else if(chosen_trec == "TREC_T13")
				{
					while(i<=50)
					{
						if(i!=3)
						{
							$('#topic').append('<option>'+(700+i)+'</option>');
						}
					
						i++;
					}
					$('.selectpicker').selectpicker('refresh');
				}
				else if(chosen_trec == "TREC_T14")
				{
					while(i<=50)
					{
						$('#topic').append('<option>'+(750+i)+'</option>');
						i++;
					}
					$('.selectpicker').selectpicker('refresh');
				}
				else if(chosen_trec == "TREC_T15")
				{
					while(i<=50)
					{
						$('#topic').append('<option>'+(800+i)+'</option>');
						i++;
					}
					$('.selectpicker').selectpicker('refresh');
				}
			
			}


			topic_setup();
			console.log( "ready!" );

			//la funzione ritorna un array contenente
			//le componenti (il nome) selezionate nella rispettiva
			//sezione di checkbox 

			function checkbox_array(checkbox_sec) {
				var selected = [];
				$('#'+checkbox_sec+' input:checked').each(function() {
					selected.push($(this).attr('value'));
				});
				
				return selected;
			
			}

			//la funzione ritorna un array contenente
			//le componenti (il nome) non selezionate nella rispettiva
			//sezione di checkbox 

			function uncheckbox_array(checkbox_sec) {
				var selected = [];
				$('#'+checkbox_sec+' input:not(:checked)').each(function() {
					selected.push($(this).attr('value'));
				});
				
				return selected;
			
			}



			function components_selection()
			{

				selectAll("stemmer", true, false);
				selectAll("stoplist", true, false);
				selectAll("model", true, false);
				var components;
				var selected_stop = checkbox_array("stoplist");	//array con le stoplist selezionate nella rispettiva checkbox
				var selected_stem = checkbox_array("stemmer"); //array congli stemmer selezionati nella rispettiva checkbox
				var selected_model = checkbox_array("model"); //array con i modelli selezionati nella rispettiva checkbox

				components = new Array();
				components["stoplist"] = new Array();
				components["stemmer"] = new Array();
				components["model"] = new Array();

				selected_stop.forEach(function(e,i)
				{
					components["stoplist"][i] = e;
				});
				selected_stem.forEach(function(e,i)
				{
					components["stemmer"][i] = e;
				});
				selected_model.forEach(function(e,i)
				{
					components["model"][i] = e;
				});

				return components;

			}

			

			function selectAll(type, val, val2)
			{

				
				$('#'+type+' input').each(function(){
					$(this).prop('checked', false);
					//console.log($(this).prop('checked', val));
					//console.log(this);
				});

				visible(type, val, val2);

			}

			function round2Fixed(value) 
			{
				value = +value;

				// Shift
				value = value.toString().split('e');
				value = Math.round(+(value[0] + 'e' + (value[1] ? (+value[1] + 2) : 2)));

				// Shift back
				value = value.toString().split('e');
				return (+(value[0] + 'e' + (value[1] ? (+value[1] - 2) : -2))).toFixed(2);
			}


			//somma tra due numeri (se sotto forma di stringhe vengono prima convertiti)
			function add(a, b) {

				//from string to number
				var a1 = +a;
				var b1 = +b;
				//sum
				return a1 + b1;
			}

			//ritorna il valore del radio button selezionato (ap o map)

			function radioval() {
				
				return $('#radiomeas input:checked').attr('value');
			
			}

			function radioLinkVal() {
				return $('#linkColor input:checked').attr('value');
			}

			function radioCurveVal() {
				return $('#curvature input:checked').attr('value');
			}

			
			console.log(radioval());
			console.log(radioLinkVal());
			
			function selectedMeasure(){

				var meas_selected = document.getElementById("measure");
				
				return meas_selected.options[meas_selected.selectedIndex].text;
			}

			function show()
			{
				$('#loader').removeClass('hidden').addClass('show');
				
			}
			function hide()
			{
				$('#loader').removeClass('show').addClass('hidden');
			}

			function normalization(precision_active_nodes, precision_nodes, boolean)
			{
				//console.log(precision_active_nodes);
				//console.log(precision_nodes);
				if(boolean)
				{
					var min = Math.min.apply(null, precision_active_nodes);
					var max = Math.max.apply(null, precision_active_nodes);
					new_precision_nodes = [];
					precision_nodes.forEach(function(d){
						if(+d>= min && +d<= max)
						{
							new_precision_nodes.push(d);
						}
					});
					precision_nodes.forEach(function(d){
						if(+d< min || +d> max)
						{
							if(d.length == 1)
							{
								var parent = d3.select('[id="'+d[0]+'"]').transition().duration(400).style("opacity", 0).transition().delay(400).attr("class", "node invisible");
							}
							else
							{//console.log(d3.select('[id="'+d[0]+"\."+d[2]+d[3]+'"]'));
								var parent = d3.select('[id="'+d[0]+"\."+d[2]+d[3]+'"]').transition().duration(400).style("opacity", 0).transition().delay(400).attr("class", "node invisible");
							}
							parent.each(function(e,i) {            
								var children = d3.selectAll(this.childNodes).transition().duration(400).style("opacity", 0).transition().delay(400).attr("visibility", "hidden");
								//console.log(children);
							});

						}
						else
						{
							//console.log(d);
							if(d.length == 1)
							{	
								var parent = d3.select('[id="'+d[0]+'"]');
								//console.log(parent);

								//console.log(d3.rgb(d3.interpolateRdYlGn(+d)));
								var children = parent
											//Convert selection to selection representing the children
											.selectAll(function() { return this.childNodes; })
											.filter('rect').transition().duration(400).attr("height", ""+(1100)/new_precision_nodes.length)
											.style("fill",  function()
											{
												if(actualSelectedNodes.indexOf(d)==-1)
													return d3.interpolateRdYlGn((+d).map(min, (max+0.04).toFixed(2), 0.00, 1.00))
												else
													return "yellow"
											})
											.style("stroke", d3.rgb(d3.interpolateRdYlGn((+d).map(min, (max+0.04).toFixed(2), 0.00, 1.00))).darker(2)
										);
											
								//parent.childNodes[0].style("fill", d3.interpolateRdYlGn((+d).map(min_value, max_value, 0.00, 0.96)));	
							}
							else
							{//console.log(d3.select('[id="'+d[0]+"\."+d[2]+d[3]+'"]'));
								var parent = d3.select('[id="'+d[0]+"\."+d[2]+d[3]+'"]');
								//console.log(parent);

								var children = parent
											//Convert selection to selection representing the children
											.selectAll(function() { return this.childNodes; })
											.filter('rect').transition().duration(400).attr("height", ""+(1100)/new_precision_nodes.length)
											.style("fill",  function()
											{
												if(actualSelectedNodes.indexOf(d)==-1)
													return d3.interpolateRdYlGn((+d).map(min, (max+0.04).toFixed(2), 0.00, 1.00))
												else
													return "yellow"
											})
											.style("stroke", d3.rgb(d3.interpolateRdYlGn((+d).map(min, (max+0.04).toFixed(2), 0.00, 1.00))).darker(2)
										);
								//parent.childNodes[0].style("fill", d3.interpolateRdYlGn((+d).map(min_value, max_value, 0.00, 0.96)));	
							}

							

						}
					});

					min_value = min;
					max_value = max;
					var new_position = 0;
					graph.nodes.forEach(function(node, i){
						if(components["stoplist"].indexOf(node.name) == -1 && components["stemmer"].indexOf(node.name) == -1 && components["model"].indexOf(node.name) == -1)
						{
							node.height = +(1100)/new_precision_nodes.length;
							if(new_precision_nodes.indexOf(node.name) != -1)
							{
								node.y = new_position;
								new_position = new_position+(1100)/new_precision_nodes.length;

							}
						}
						
					});
					//console.log(graph.nodes);
					
					
					var new_position = 0;
					new_precision_nodes.forEach(function(node){
						var sel = d3.select('[id="'+node+'"]');
						
						var currentx = d3.transform(sel.attr("transform")).translate[0];
						//console.log(sel);

						d3.select('[id="'+node+'"]').transition()
							.duration(400)
							.attr("transform", "translate(" + currentx + "," + (this.y = new_position) + ")"
							);
						new_position = new_position+(1100)/new_precision_nodes.length;

						//console.log(sel);
						/*d3.select("#"+node[0])
							.transition()
							.duration(400)
								.attr("transform", "translate(" + node.x + "," + (node[0].__data__.y -= nodeHeight) + ")"
							);
						*/
					});

					//path = sankey.link().curvature(0.5);
					link.transition()
						.duration(700).attr("d", path);//.sort(function(a,b){return a.ty - b.ty;});

					link_color(700);
					
				}
				else
				{
					//console.log(precision_nodes);
					precision_nodes.forEach(function(d){
						
						//console.log(actualSelectedNodes);
						if(d.length == 1)
						{
							console.log(d);
							var parent = d3.select('[id="'+d[0]+'"]');
							//console.log(parent);
							var children = parent
										//Convert selection to selection representing the children
										.selectAll(function() { return this.childNodes; });
								children
										.filter('rect').transition().duration(400).attr("height", ""+40)
										.style("fill", function()
										{
											if(actualSelectedNodes.indexOf(d)==-1)
												return d3.interpolateRdYlGn(+d)
											else
												return "yellow"
										})
										.style("stroke",  d3.rgb(d3.interpolateRdYlGn(+d)).darker(2)
										);
								children.attr("visibility", "visible").style("opacity", 1);

							parent.attr("class", "node visible").style("opacity", 1);		
							//parent.childNodes[0].style("fill", d3.interpolateRdYlGn((+d).map(min_value, max_value, 0.00, 0.96)));	
						}
						else
						{//console.log(d3.select('[id="'+d[0]+"\."+d[2]+d[3]+'"]'));
							var parent = d3.select('[id="'+d[0]+"\."+d[2]+d[3]+'"]');
							//console.log(parent);

							var children = parent
										//Convert selection to selection representing the children
										.selectAll(function() { return this.childNodes; });
								children
										.filter('rect').transition().duration(400).attr("height", ""+40)
										.style("fill", function()
										{
											if(actualSelectedNodes.indexOf(d)==-1)
												return d3.interpolateRdYlGn(+d)
											else
												return "yellow"
										})
										.style("stroke", d3.rgb(d3.interpolateRdYlGn(+d)).darker(2)
										);
								children.attr("visibility", "visible").style("opacity", 1);

							parent.attr("class", "node visible").style("opacity", 1);
							//parent.childNodes[0].style("fill", d3.interpolateRdYlGn((+d).map(min_value, max_value, 0.00, 0.96)));	
						}
					
						//d3.select("[id = +d]").attr("class", "node visible");

					
					});

					min_value = 0;
					max_value = 0.96;

					var new_position = 0;
					graph.nodes.forEach(function(node, i){
						if(components["stoplist"].indexOf(node.name) == -1 && components["stemmer"].indexOf(node.name) == -1 && components["model"].indexOf(node.name) == -1)
						{
							node.height = +40;

							node.y = new_position;
							new_position = new_position+40;

						}
						
					});

					var new_position = 0;
					precision_nodes.forEach(function(node){
						var sel = d3.select('[id="'+node+'"]');

						// get x position
						var currentx = d3.transform(sel.attr("transform")).translate[0];


						//console.log(sel);

						d3.select('[id="'+node+'"]').transition()
							.duration(400)
							.attr("transform", "translate(" + currentx + "," + (this.y = new_position) + ")"
							);
						new_position = new_position+40;

						//console.log(sel);
						/*d3.select("#"+node[0])
							.transition()
							.duration(400)
								.attr("transform", "translate(" + node.x + "," + (node[0].__data__.y -= nodeHeight) + ")"
							);
						*/
					});

					//path = sankey.link().curvature(0.5);
					link.transition()
						.duration(400).attr("d", path);//.sort(function(a,b){return a.ty - b.ty;});


					link_color(700);

				}

				/*d3.selectAll("[node-selected='1']")
					.style("filter", "brightness(400%)")
					.style("fill", "yellow");
				*/
			}



			//console.log(test2([0.6, 0.4, 0.1, 2]))

			Number.prototype.map = function (in_min, in_max, out_min, out_max) {
				return (this - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
			}

			var linkTooltipOffset = 0;
      		var nodeTooltipOffset = 13;
			
			var paths;
			var systems;
			var selected_stop;	//array con le stoplist selezionate nella rispettiva checkbox
			var selected_stem; //array congli stemmer selezionati nella rispettiva checkbox
			var selected_model;
			var precision_nodes; //array di nodi di AP/MAP
			var precision_active_nodes; //array di nodi di AP/MAP che partecipano al sankey
			var components = components_selection();
			var color;
			var list_of_path;
			var path_link;
			var metadata;

			var graph;
			var sankey;
			var path;
			var max_min = 1;
			var min_value = 0;
			var max_value = 0.96;
			var link;
			var medie = new Array();


			var max_media_modelli;
			var max_media_stem;
			var max_media_stop;

			var min_media_modelli;
			var min_media_stem;
			var min_media_stop;

			var media_link;

			var actualSelectedNodes = [];

			var actualInvisibleNodes = [];

			var flag;
			
			//console.log(radioval());
			/*
				Funzione che definisce la creazione del Sankey
			*/			
			function generateSankey(min = 0, max = 0.96) //nodi_da_accendere
			{
				

				var radio = radioval();

				//console.log(radioval());


				min_value = min;
				max_value = max;
				var element = document.getElementsByClassName("tipsy tipsy-w")[0];
				if(element != undefined)
					element.parentNode.removeChild(element);


				d3.json("data/infodati.json", function(error, data) {
					metadata = data;
				});

				
				

				//console.log(colorScheme);
				
				//larghezza della sezione dedicata al sankey. Il valore verrà
				//utilizzato per definire le misure del canvas
				var sizeDiv = +$("#sankey").width() -20;


				//selezione collezione
				var trec_selected = document.getElementById("collection");
				var chosen_trec = trec_selected.options[trec_selected.selectedIndex].text;
	
				console.log(chosen_trec);
				
				
				//selezione del topic
				if(radio =="tbt")
				{
					var topic_select = document.getElementById("topic");
					var chosen_topic_index = topic_select.selectedIndex;
					var chosen_topic = +topic_select.options[chosen_topic_index].text;
				}
				else
				{
					chosen_trec=chosen_trec+"m";
				}		
			
				var units = "links";
				
				//dimensionamento del canvas (formato quadrato)
				var margin = {top: 10, right: 10, bottom: 10, left: 10},
					width = sizeDiv - margin.left - margin.right,
					height = 1120 - margin.top - margin.bottom;


				  /* Inizializzazione tooltip */
				var tipLinks = d3.tip()
					.attr('class', 'd3-tip d3-tip-link')
					//.rootElement(document.getElementById('chart'))
					.offset([-10,0]);
					

										
				var tipNodes = d3.tip()
					.attr('class', 'd3-tip d3-tip-nodes')
					.direction("n")
					.offset([-10, 40]);


				var tipAP = d3.tip()
					.attr('class', 'd3-tip d3-tip-nodes')
					.direction("n")
					.offset([-10, -60]);

				var tipMeas = d3.tip()
					.attr('class', 'd3-tip d3-tip-nodes')
					.offset([-10, 0]);


				var formatNumber = d3.format(",.0f"),    // zero decimal places
					format = function(d) { return formatNumber(d) + " " + units; };
				color = d3.scale.category20();
				//d3.interpolateRdYlGn = d3.interpolateRdYlGn(); // scala di colori per i nodi
				
				
				// aggiungi il canvas alla pagina
				var svg = d3.select("#chart").append("svg")
					.attr("id", "sankey_svg")
					.attr("preserveAspectRatio", "xMinYMin meet")
					.attr("viewBox", "0 0 "+(width + margin.left + margin.right)+" "+ (height + margin.top + margin.bottom))
					.classed("svg-content", true)
					//.attr("width", width + margin.left + margin.right)
					//.attr("height", height + margin.top + margin.bottom)
				    .attr("class", "sankey")
					.call(tipLinks)
      				.call(tipNodes)
					  .call(tipAP)
					.append("g")
					.attr("transform", 
						  "translate(" + margin.left + "," + margin.top + ")");
					
				
											
				// Proprietà del sankey
				sankey = d3.sankey()
					.nodeWidth(12) //larghezza dei nodi
					.nodePadding(1) //spazio tra i nodi
					.size([height, width]) // dimensione sankey
					.layout(0);

				path = sankey.link().curvature(0.5);
				
				selected_stop = components["stoplist"];	//array con le stoplist selezionate nella rispettiva checkbox
				selected_stem = components["stemmer"]; //array congli stemmer selezionati nella rispettiva checkbox
				selected_model = components["model"]; //array con i modelli selezionati nella rispettiva checkbox
				
				list_of_path = {};


				//components = new Array();
				//components["stoplist"] = new Array();
				//components["stemmer"] = new Array();
				//components["model"] = new Array();
				/*
				selected_stop.forEach(function(e,i)
				{
					components["stoplist"][i] = e;
				});
				selected_stem.forEach(function(e,i)
				{
					components["stemmer"][i] = e;
				});
				selected_model.forEach(function(e,i)
				{
					components["model"][i] = e;
				});
				*/
				paths = new Array();
				var path_stop = new Array();
				var path_stem = new Array();
				var path_model = new Array();
				var path_ap = new Array();
				path_link = new Array();
				//console.log(components);
				//console.log(components.stoplist);
				//console.log(components.stoplist[4]);

				systems = new Array();

				max_min = round2Fixed(max_value+0.04);
				
				
				//lettura dei dati csv e memorizzazione
				d3.csv("data/"+chosen_trec+".csv", function(error, data) {

					precision_nodes = [];
					precision_active_nodes = [];
					graph = {"nodes" : [], "links" : []};
					
					var cluster_ap = min_value;
					if(min_value!=0)
						cluster_ap = min_value.toFixed(2);
					while((+cluster_ap) < (max_value+0.04).toFixed(2))
					{
						precision_nodes.push(""+cluster_ap);
						graph.nodes.push({"name": ""+cluster_ap, "height":+40, "width":+12,"scale":+1.0});

						if(paths[cluster_ap] == null)
						{
							paths[cluster_ap] = [];
							path_ap[cluster_ap] = [];
						}


						cluster_ap = (+cluster_ap)+0.04;
						cluster_ap = (+cluster_ap).toFixed(2);
						//console.log(cluster_ap);
					}
					if(min_value == max_value)
					{
						max_value = (max_value+0.04).toFixed(2);
					}
					
					
					var id = 0;
					var index = 1;

					var firstcomp = d3.select("[position='1']")[0][0].id,
						secondcomp = d3.select("[position='2']")[0][0].id,
						thirdcomp = d3.select("[position='3']")[0][0].id;

					if(firstcomp == "stoplist")
					{
						firstcomp = "stop";
					}
					else if(secondcomp == "stoplist")
					{
						secondcomp = "stop";
					}
					else
					{
						thirdcomp = "stop";
					}

					//console.log(firstcomp);
					//console.log(secondcomp);
					//console.log(thirdcomp);

					var measure = selectedMeasure();

					var nodes_added = [];
					data.forEach(function (d) {
					
						if(d.topic == chosen_topic){ //seleziono solo i dati relativi al topic selezionato
							
							var ap_value = d[measure],
								model_value = d.model,
								stemmer_value = d.stemmer,
								stop_value = d.stop;

							var system_name = "s"+index;
							systems[system_name] = new Array();
							systems[system_name].components = [d[firstcomp], d[secondcomp], d[thirdcomp]];
							systems[system_name].ap = +ap_value;

							if(radioval()=="average")
							{
								systems[system_name].errvariation = +d["ss"+measure+"w"];
							//	systems[system_name].sumMeasureSquared = +d["s"+measure+"square"];
								systems[system_name].variance = +d["m"+measure+"var"];
								
							}

							if(paths[stop_value] == null)
							{
								paths[stop_value] = [];
								path_stop[stop_value] = [];
							}
							paths[stop_value].push(system_name);
							path_stop[stop_value].push(system_name);
							if(paths[stemmer_value] == null)
							{
								paths[stemmer_value] = [];
								path_stem[stemmer_value] = [];
							}  
							paths[stemmer_value].push(system_name);
							path_stem[stemmer_value].push(system_name);
							if(paths[model_value] == null)
							{
								paths[model_value] = [];
								path_model[model_value] = [];
							}
							paths[model_value].push(system_name);
							path_model[model_value].push(system_name);


							index++;
							
							//"value":40,"coverageCount":40,"utilizationCount":40,"scale":3.0
							if(nodes_added.indexOf(d.stop) == -1){
								graph.nodes.push({"name": d.stop, "height":+154, "width":+12, "component":"stoplist"});
								nodes_added.push(d.stop);
							}
							if(nodes_added.indexOf(d.stemmer) == -1){
								graph.nodes.push({"name": d.stemmer, "height":+154, "width":+12, "component":"stemmer"});
								nodes_added.push(d.stemmer);
							}
							if(nodes_added.indexOf(d.model) == -1){
								graph.nodes.push({"name": d.model, "height":+56, "width":+12, "component":"model"});
								nodes_added.push(d.model);
							}
							//graph.nodes.push({"name": d[measure]});
							if(firstcomp == "stop" && secondcomp == "stemmer" && thirdcomp == "model")
							{
								$("#title1").html("<h4>Stoplist</h4>");
								$("#title2").html("<h4>Stemmer</h4>");
								$("#title3").html("<h4>Model</h4>");
							
								var index1 = graph.links.findIndex(x => x.source==d.stop && x.target==d.stemmer);
								
								if (index1 == -1){ //se il link non � gi� stato inserito, inseriscilo
								
								
									graph.links.push({"id": id,
													"source": d.stop,
													"target": d.stemmer,
													"value": +1});
									
									
									list_of_path["link-"+id] = [];

									path_link["link-"+id]  = [];

								//	if(id!=0)
								//	{
										id += 1;
										
								//	}
									
									
								}
								
								
								var index2 = graph.links.findIndex(x => x.source==d.stemmer && x.target==d.model);
								//console.log(index2);
								if (index2 == -1){
									graph.links.push({"id":id,
													"source": d.stemmer,
													"target": d.model,
													"value": +1});
									
									list_of_path["link-"+id] = [];
									path_link["link-"+id]  = [];
									id += 1;
											
								}

								if(d[measure] >= 1)
								{
									var i1 = 0.96;
									graph.links.push({"id": id,
														"source": d.model,
														"target": ""+0.96,
														"value": +1,
													"finalValue": +d[measure]});
								}
								else
								{
									var i1 = 0;
									var i2 = 0.04;

									while((+i1)<1.0)
									{
										if( (+d[measure])>=(+i1) && (+d[measure])<(+i2) )
										{
											graph.links.push({"id": id,
															"source": d.model,
															"target": ""+i1,
															"value": +1,
													"finalValue": +d[measure]});
											
											break;
										}
										else
										{
											i1 = round2Fixed((+i1)+0.04);
											i2 = round2Fixed((+i2)+0.04);
										}
									}
								}

								systems[system_name].apCluster = +i1;
							}
							else if(firstcomp == "stop" && secondcomp == "model" && thirdcomp == "stemmer")
							{
								$("#title1").html("<h4>Stoplist</h4>");
								$("#title2").html("<h4>Model</h4>");
								$("#title3").html("<h4>Stemmer</h4>");
							
								var index1 = graph.links.findIndex(x => x.source==d.stop && x.target==d.model);
								
								if (index1 == -1){ //se il link non � gi� stato inserito, inseriscilo
								
								
									graph.links.push({"id": id,
													"source": d.stop,
													"target": d.model,
													"value": +1});
									
									
									list_of_path["link-"+id] = [];

									path_link["link-"+id]  = [];									
								//	if(id!=0)
								//	{
										id += 1;
										
								//	}
									


								}
								
								
								var index2 = graph.links.findIndex(x => x.source==d.model && x.target==d.stemmer);
								//console.log(index2);
								if (index2 == -1){
									graph.links.push({"id":id,
													"source": d.model,
													"target": d.stemmer,
													"value": +1});
									
									list_of_path["link-"+id] = [];
									path_link["link-"+id]  = [];
									
									id += 1;
											
								}

								if(d[measure] >= 1)
								{
									var i1 = 0.96;
									graph.links.push({"id": id,
														"source": d.stemmer,
														"target": ""+0.96,
														"value": +1,
													"finalValue": +d[measure]});
								}
								else
								{

									var i1 = 0;
									var i2 = 0.04;

									while((+i1)<1.0)
									{
										if( (+d[measure])>=(+i1) && (+d[measure])<(+i2) )
										{
											graph.links.push({"id": id,
															"source": d.stemmer,
															"target": ""+i1,
															"value": +1,
													"finalValue": +d[measure]});
											
											break;
										}
										else
										{
											i1 = round2Fixed((+i1)+0.04);
											i2 = round2Fixed((+i2)+0.04);
										}
									}
								}
								systems[system_name].apCluster = +i1;
							}
							else if(firstcomp == "stemmer" && secondcomp == "stop" && thirdcomp == "model")
							{
								$("#title1").html("<h4>Stemmer</h4>");
								$("#title2").html("<h4>Stoplist</h4>");
								$("#title3").html("<h4>Model</h4>");
							
								var index1 = graph.links.findIndex(x => x.source==d.stemmer && x.target==d.stop);
								
								if (index1 == -1){ //se il link non � gi� stato inserito, inseriscilo
								
								
									graph.links.push({"id": id,
													"source": d.stemmer,
													"target": d.stop,
													"value": +1});
									
									
									list_of_path["link-"+id] = [];

									path_link["link-"+id]  = [];
								//	if(id!=0)
								//	{
										id += 1;
										
								//	}
									
									

								}
								
								
								var index2 = graph.links.findIndex(x => x.source==d.stop && x.target==d.model);
								//console.log(index2);
								if (index2 == -1){
									graph.links.push({"id":id,
													"source": d.stop,
													"target": d.model,
													"value": +1});
									
									list_of_path["link-"+id] = [];
									path_link["link-"+id]  = [];
									
									id += 1;
											
								}

								if(d[measure] >= 1)
								{
									var i1 = 0.96;
									graph.links.push({"id": id,
														"source": d.model,
														"target": ""+0.96,
														"value": +1,
													"finalValue": +d[measure]});
								}
								else
								{

									var i1 = 0;
									var i2 = 0.04;

									while((+i1)<1.0)
									{
										if( (+d[measure])>=(+i1) && (+d[measure])<(+i2) )
										{
											graph.links.push({"id": id,
															"source": d.model,
															"target": ""+i1,
															"value": +1,
													"finalValue": +d[measure]});
											
											break;
										}
										else
										{
											i1 = round2Fixed((+i1)+0.04);
											i2 = round2Fixed((+i2)+0.04);
										}
									}
								}

								systems[system_name].apCluster = +i1;
							}
							else if(firstcomp == "stemmer" && secondcomp == "model" && thirdcomp == "stop")
							{
								$("#title1").html("<h4>Stemmer</h4>");
								$("#title2").html("<h4>Model</h4>");
								$("#title3").html("<h4>Stoplist</h4>");
							
								var index1 = graph.links.findIndex(x => x.source==d.stemmer && x.target==d.model);
								
								if (index1 == -1){ //se il link non � gi� stato inserito, inseriscilo
								
								
									graph.links.push({"id": id,
													"source": d.stemmer,
													"target": d.model,
													"value": +1});
									
									
									list_of_path["link-"+id] = [];

									path_link["link-"+id]  = [];
								//	if(id!=0)
								//	{
										id += 1;
										
								//	}
									
									

								}
								
								
								var index2 = graph.links.findIndex(x => x.source==d.model && x.target==d.stop);
								//console.log(index2);
								if (index2 == -1){
									graph.links.push({"id":id,
													"source": d.model,
													"target": d.stop,
													"value": +1});
									
									list_of_path["link-"+id] = [];
									path_link["link-"+id]  = [];
									id += 1;
											
								}
								
								if(d[measure] >= 1)
								{
									var i1 = 0.96;
									graph.links.push({"id": id,
														"source": d.stop,
														"target": ""+0.96,
														"value": +1,
													"finalValue": +d[measure]});
								}
								else
								{
									var i1 = 0;
									var i2 = 0.04;

									while((+i1)<1.0)
									{
										if( (+d[measure])>=(+i1) && (+d[measure])<(+i2) )
										{
											graph.links.push({"id": id,
															"source": d.stop,
															"target": ""+i1,
															"value": +1,
															"finalValue": +d[measure]});
											
											break;
										}
										else
										{
											i1 = round2Fixed((+i1)+0.04);
											i2 = round2Fixed((+i2)+0.04);
										}
									}
								}

								systems[system_name].apCluster = +i1;
							}
							else if(firstcomp == "model" && secondcomp == "stop" && thirdcomp == "stemmer")
							{
								$("#title1").html("<h4>Model</h4>");
								$("#title2").html("<h4>Stoplist</h4>");
								$("#title3").html("<h4>Stemmer</h4>");
							
								var index1 = graph.links.findIndex(x => x.source==d.model && x.target==d.stop);
								
								if (index1 == -1){ //se il link non � gi� stato inserito, inseriscilo
								
								
									graph.links.push({"id": id,
													"source": d.model,
													"target": d.stop,
													"value": +1});
									
									
									list_of_path["link-"+id] = [];

									path_link["link-"+id]  = [];
								//	if(id!=0)
								//	{
										id += 1;
										
								//	}
									
									

								}
								
								
								var index2 = graph.links.findIndex(x => x.source==d.stop && x.target==d.stemmer);
								//console.log(index2);
								if (index2 == -1){
									graph.links.push({"id":id,
													"source": d.stop,
													"target": d.stemmer,
													"value": +1});
									

									list_of_path["link-"+id] = [];
									path_link["link-"+id]  = [];
									id += 1;
											
								}

								if(d[measure] >= 1)
								{
									var i1 = 0.96;
									graph.links.push({"id": id,
														"source": d.stemmer,
														"target": ""+0.96,
														"value": +1,
													"finalValue": +d[measure]});
								}
								else
								{
									var i1 = 0;
									var i2 = 0.04;

									while((+i1)<1.0)
									{
										if( (+d[measure])>=(+i1) && (+d[measure])<(+i2) )
										{
											graph.links.push({"id": id,
															"source": d.stemmer,
															"target": ""+i1,
															"value": +1,
													"finalValue": +d[measure]});
											
											break;
										}
										else
										{
											i1 = round2Fixed((+i1)+0.04);
											i2 = round2Fixed((+i2)+0.04);
										}
									}
								}

								systems[system_name].apCluster = +i1;
							}
							else
							{
								$("#title1").html("<h4>Model</h4>");
								$("#title2").html("<h4>Stemmer</h4>");
								$("#title3").html("<h4>Stoplist</h4>");
								
								var index1 = graph.links.findIndex(x => x.source==d.model && x.target==d.stemmer);
								
								if (index1 == -1){ //se il link non � gi� stato inserito, inseriscilo
								
								
									graph.links.push({"id": id,
													"source": d.model,
													"target": d.stemmer,
													"value": +1});
									
									
									list_of_path["link-"+id] = [];

									path_link["link-"+id]  = [];
									
								//	if(id!=0)
								//	{
										id += 1;
										
								//	}
									
									

								}
								
								
								var index2 = graph.links.findIndex(x => x.source==d.stemmer && x.target==d.stop);
								//console.log(index2);
								if (index2 == -1){
									graph.links.push({"id":id,
													"source": d.stemmer,
													"target": d.stop,
													"value": +1});
									
									list_of_path["link-"+id] = [];
									path_link["link-"+id]  = [];
									
									id += 1;
											
								}

								if(d[measure] >= 1)
								{
									var i1 = 0.96;
									graph.links.push({"id": id,
														"source": d.stop,
														"target": ""+0.96,
														"value": +1,
														"finalValue": +d[measure]});
								}
								else
								{
									var i1 = 0;
									var i2 = 0.04;

									while((+i1)<1.0)
									{
										if( (+d[measure])>=(+i1) && (+d[measure])<(+i2) )
										{
											graph.links.push({"id": id,
															"source": d.stop,
															"target": ""+i1,
															"value": +1,
													"finalValue": +d[measure]});
											
											break;
										}
										else
										{
											i1 = round2Fixed((+i1)+0.04);
											i2 = round2Fixed((+i2)+0.04);
										}
									}
								}
								systems[system_name].apCluster = +i1;
								
							}
							
							paths[i1].push(system_name);
							path_ap[i1].push(system_name);
							

							if(precision_active_nodes.indexOf(""+i1) == -1)
								precision_active_nodes.push(""+i1);
							//console.log(precision_active_nodes);
							
							list_of_path["link-"+id] = [];
							path_link["link-"+id]  = [];							
							
							
						
							if(index1==-1 && index2==-1)
							{
								systems[system_name].path = [id, id-1, id-2];

								list_of_path["link-"+id].push([id, id-1, id-2, ap_value]);
								list_of_path["link-"+(id-1)].push([id, id-1, id-2, ap_value]);
								list_of_path["link-"+(id-2)].push([id, id-1, id-2, ap_value]);
								path_link["link-"+id].push(system_name);
								path_link["link-"+(id-1)].push(system_name);
								path_link["link-"+(id-2)].push(system_name);
								
							}
							else if(index1==-1 && index2!=-1)
							{
								systems[system_name].path = [id, index2, id-1];

								list_of_path["link-"+id].push([id, index2, id-1, ap_value]);
								list_of_path["link-"+index2].push([id, index2, id-1, ap_value]);
								list_of_path["link-"+(id-1)].push([id, index2, id-1, ap_value]);
								path_link["link-"+id].push(system_name);
								path_link["link-"+index2].push(system_name);
								path_link["link-"+(id-1)].push(system_name);

							}
							else if(index2==-1 && index1!=-1)
							{
								systems[system_name].path = [id, id-1, index1];
								
								list_of_path["link-"+id].push([id, id-1, index1, ap_value]);
								list_of_path["link-"+(id-1)].push([id, id-1, index1, ap_value]);
								list_of_path["link-"+index1].push([id, id-1, index1, ap_value]);
								path_link["link-"+id].push(system_name);
								path_link["link-"+(id-1)].push(system_name);
								path_link["link-"+index1].push(system_name);

							}
							else
							{
								systems[system_name].path = [id, index2, index1];

								list_of_path["link-"+id].push([id, index2, index1, ap_value]);
								list_of_path["link-"+index2].push([id, index2, index1, ap_value]);
								list_of_path["link-"+index1].push([id, index2, index1, ap_value]);
								path_link["link-"+id].push(system_name);
								path_link["link-"+index2].push(system_name);
								path_link["link-"+index1].push(system_name);

							}

							id += 1;
							
						}
					});


					max_media_modelli = 0;
					max_media_stem = 0;
					max_media_stop = 0;

					min_media_modelli = 1;
					min_media_stem = 1;
					min_media_stop = 1;

					graph.nodes.forEach(function(node){

						var sistemi = paths[node.name];
						var prec_array = [];
						for(index = 0; index<sistemi.length; index++)
						{
							prec_array.push(systems[sistemi[index]].ap);
						}
						var media = ap_mean(prec_array);
						
						if(actualInvisibleNodes.indexOf(node.name) == -1)
						{
							
							var media1 = media;
						}
						else
							var media1 = 0.0;

						node["apMean"] = +(media1).toFixed(4);

						medie[node.name] = +(media1).toFixed(4);

						if(components["stoplist"].indexOf(node.name) != -1)
						{
							if(media > max_media_stop)
							{
								max_media_stop = media;
							}
							if(media < min_media_stop)
							{
								min_media_stop = media;
							}
						}
						else if(components["stemmer"].indexOf(node.name) != -1)
						{
							if(media > max_media_stem)
							{
								max_media_stem = media;
							}
							if(media < min_media_stem)
							{
								min_media_stem = media;
							}
						}
						else if(components["model"].indexOf(node.name) != -1)
						{
							if(media > max_media_modelli)
							{
								max_media_modelli = media;
							}
							if(media < min_media_modelli)
							{
								min_media_modelli = media;
							}
						}

					});

					media_link = 0;
					
			//		console.log(graph.links);
					graph.links.forEach(function(link, i){

						var sistemi = path_link["link-"+i];

						var prec_array = [];
						for(index = 0; index<sistemi.length; index++)
						{
							prec_array.push(systems[sistemi[index]].ap);
							
						}
					
						var media = ap_mean(prec_array);

						link["apMean"] = +(media).toFixed(4);

						medie["link-"+i] = +(media).toFixed(4);

						//console.log("link-" + link.id + " " +(media).toFixed(4));
						
						if(media > media_link)
						{
							media_link = media;
						}

					});

					console.log(graph.links);
					
					//var thirdcomp = d3.select("[position='3']")[0][0].id;
					//var secondcomp = d3.select("[position='2']")[0][0].id;
					//var firstcomp = d3.select("[position='1']")[0][0].id;
					//var sizeThirdComp = 0;
					//var sizeSecondComp = 0;
					//var sizeFirstComp = 0;
					//var elementThirdComp = [];
					//var elementSecondComp = [];
					//var elementFirstComp = [];

					graph.nodes.forEach(function(node, i){
						if(components["stoplist"].indexOf(node.name) != -1)
						{
							node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stop;
							node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stop;
							if(node.height < 30)
							{
								node.height = 30;
							}
							else if(node.height > 182)
							{
								node.height = 182;
							}

							if(node.width < 9)
							{
								node.width = 9;
							}
							else if(node.width > 25)
							{
								node.width = 25;
							}
						}
						else if(components["stemmer"].indexOf(node.name) != -1)
						{
							node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stem;
							node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stem;
							if(node.height < 30)
							{
								node.height = 30;
							}
							else if(node.height > 182)
							{
								node.height = 182;
							}

							if(node.width < 9)
							{
								node.width = 9;
							}
							else if(node.width > 25)
							{
								node.width = 25;
							}
						}
						else if(components["model"].indexOf(node.name) != -1)
						{
							node.height = ((+node.apMean+0.0002).toFixed(4)*47)/max_media_modelli;
							node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_modelli;
							//node.width = ((node.apMean).map(min_media_modelli, max_media_modelli, 12.0, 25.0).toFixed(4));

							if(node.height < 30)
							{
								node.height = 30;
							}
							else if(node.height > 65)
							{
								node.height = 65;
							}

							if(node.width < 9)
							{
								node.width = 9;
							}
							else if(node.width > 25)
							{
								node.width = 25;
							}
						}


					});

					graph.links.forEach(function(link, i){
						
						//console.log(link.id + " " + link.apMean + " " + link.value)
						link.value = ((medie["link-"+i]).toFixed(4))/media_link;
						if(!(link.value > 0))
						{
							link.value = 0.002;
						}
						//console.log(link.id + " " + link.apMean + " " + link.value)
					});


				/*	while(sizeThirdComp <= 750)
					{
						elementThirdComp.forEach(function(index)
						{ 
							var oldHeight =  graph.nodes[index].height;
							graph.nodes[index].height = oldHeight*1.4;
							
						});
						sizeThirdComp = sizeThirdComp*1.4;
					}
					while(sizeThirdComp <= 900)
					{
						elementThirdComp.forEach(function(index)
						{ 
							var oldHeight =  graph.nodes[index].height;
							graph.nodes[index].height = oldHeight*1.2;
							
						});
						sizeThirdComp = sizeThirdComp*1.2;
					}
					while(sizeThirdComp <= 1000)
					{
						elementThirdComp.forEach(function(index)
						{ 
							var oldHeight =  graph.nodes[index].height;
							graph.nodes[index].height = oldHeight*1.1;
							
						});
						sizeThirdComp = sizeThirdComp*1.1;
					}

					while(sizeSecondComp <= 750)
					{
						elementSecondComp.forEach(function(index)
						{ 
							var oldHeight =  graph.nodes[index].height;
							graph.nodes[index].height = oldHeight*1.4;
							
						});
						sizeSecondComp = sizeSecondComp*1.4;
					}
					while(sizeSecondComp <= 900)
					{
						elementSecondComp.forEach(function(index)
						{ 
							var oldHeight =  graph.nodes[index].height;
							graph.nodes[index].height = oldHeight*1.2;
							
						});
						sizeSecondComp = sizeSecondComp*1.2;
					}
					while(sizeSecondComp <= 1000)
					{
						elementSecondComp.forEach(function(index)
						{ 
							var oldHeight =  graph.nodes[index].height;
							graph.nodes[index].height = oldHeight*1.1;
							
						});
						sizeSecondComp = sizeSecondComp*1.1;
					}

					while(sizeFirstComp <= 750)
					{
						elementFirstComp.forEach(function(index)
						{ 
							var oldHeight =  graph.nodes[index].height;
							graph.nodes[index].height = oldHeight*1.4;
							
						});
						sizeFirstComp = sizeFirstComp*1.4;
					}
					while(sizeFirstComp <= 900)
					{
						elementFirstComp.forEach(function(index)
						{ 
							var oldHeight =  graph.nodes[index].height;
							graph.nodes[index].height = oldHeight*1.2;
							
						});
						sizeFirstComp = sizeFirstComp*1.2;
					}
					while(sizeFirstComp <= 1000)
					{
						elementFirstComp.forEach(function(index)
						{ 
							var oldHeight =  graph.nodes[index].height;
							graph.nodes[index].height = oldHeight*1.1;
							
						});
						sizeFirstComp = sizeFirstComp*1.1;
					} */
					//console.log(elementThirdComp);
					//console.log(sizeThirdComp);



					//console.log("Max modelli: " + media_modelli);
					//console.log("Max stemmer: " + max_media_stem);
					//console.log("Max stoplist: " + max_media_stop);

					//console.log(precision_nodes);
					//console.log(precision_active_nodes);

					//console.log(list_of_path);
					console.log(systems);
					//console.log(path_stem);
					//console.log(path_stop);
					//console.log(path_model);
					//console.log(graph.nodes);
					//console.log(graph.links);
					//console.log(path_ap);

					// ordinamento alfabetico dei nodi
					// soluzione momentanea per permettere un ordinamento dei valori di AP 
					graph.nodes.sort(function (a, b) {

						//valori possibili
						var a_first = -1; // a viene prima
						var b_first =  1; // b viene prima
						var equal = 0; // a e b sono uguali

						// confronto tra i nomi
						if (b.name < a.name) {
							return b_first;
						}
						else if (a.name < b.name) {
							return a_first;
						}
						else {
							return equal;
						}
					});	
					
					//console.log(graph);
				
					//i nodi devono essere univoci
					var tempnodes = d3.keys(d3.nest()
						.key(function(d) { return d.name;})
						.map(graph.nodes));
					
					/*graph.nodes = d3.keys(d3.nest()
						.key(function(d) { return d.name;})
						.map(graph.nodes));*/
					

					
					
					//console.log(graph);	
					
					// loop tra i link per sostituire valori stringa con valori indice
					// Il metodo ComputeNodeLinks vuole indici per source e target dei link
					graph.links.forEach(function (d, i) {
						graph.links[i].source = tempnodes.indexOf(graph.links[i].source);
						graph.links[i].target = tempnodes.indexOf(graph.links[i].target);
					});
					
					//console.log(graph.nodes[graph.links[2].source]);

					//loop tra i nodi
					//array di object invece di array di stringhe
					/*graph.nodes.forEach(function (d, i) {
						graph.nodes[i] = { "name": d.name };
					});*/


					//setting dei tooltip (links)
					//N.B. per i link sono già definite delle funzioni on mouse over
					// "➡" 
					tipLinks.html(function(d) {
						var object = d3.entries(d),
							linkName = object[0].value,
							finalLinkName = "link-"+linkName,
							source = d.source.name,
							target = d.target.name,
							linkAverage = (+medie["link-"+linkName]).toFixed(4),
							html;
						var systems_dunnett = [];
						if(radioval() == "average" && isNaN(+target))
						{
							systems_dunnett = dunnett_link(finalLinkName);
							systems_dunnett = systems_dunnett.sort(compare);
						}

						//console.log(systems_dunnett);

						//var prec_array = [];
						var link_systems = top_ten_link("link-"+linkName);
						
							
						if(link_systems.length > 0)
						{
							html = '<tr><td><h2>Best Path:</h2></td><td></td></tr>';
							
							html += '<tr>'+ //sistemi[index]
								'<td class="col-left">'+systems[link_systems[0]].components.toString()+'</td>'+
								'<td align="right"><span style="color:'+d3.interpolateRdYlGn(+systems[link_systems[0]].ap)+'">'+(+systems[link_systems[0]].ap).toFixed(4)+'</span></td>'+
								'</tr>';

							if(systems_dunnett.length > 0 && isNaN(+target))
							{
								var index;
								html = html + '<tr><td><p style="margin-top: 2px; margin-bottom: 0px;"><strong>Top Group (Dunnett\'s test):</strong></p></td><td></td></tr>';
								for(index = 0; index<systems_dunnett.length; index++)
								{	
									if(index == 5)
									{
										html +=  //sistemi[index]
									'<td align="center"><p style="font-size: 80%; margin-top: 2px; margin-bottom: 0px;">First five results</p></td>';
										break;
									}

									html += '<tr>'+ //sistemi[index]
									'<td class="col-left">'+systems[systems_dunnett[index]].components.toString()+'</td>'+
									'<td align="right"><span style="color:'+d3.interpolateRdYlGn(+systems[systems_dunnett[index]].ap)+'">'+(+systems[systems_dunnett[index]].ap).toFixed(4)+'</span></td>'+
									'</tr>';

								}

							}
						}

						if(isNaN(+target))
						{
						//var mean = ap_mean(prec_array).toFixed(4);
							html = '<div class="table-wrapper">'+
								'<h1>Link:</h1><h2>'+source+ " ➡ " + target+'</h2>'+
								'<table>'+ '<tr>'+
								'<td class="col-left"><strong>Average:</strong></td>'+
								'<td align="right"><span style="color:'+d3.interpolateRdYlGn(+linkAverage)+'">'+ linkAverage +'</span></td>'+
								html+
								
								'</tr></table></div>';

						}
						else
						{
							html = '<div class="table-wrapper">'+
								'<h1>Link:</h1><h2>'+source+ " ➡ " + target+'</h2>'+
								'<table>'+ '<tr>'+
								'<td class="col-left">'+ systems[link_systems[0]].components[0] + " ➡ " + systems[link_systems[0]].components[1]+" ➡ "+ systems[link_systems[0]].components[2]+':</td>'+
								'<td align="right"><span style="color:'+d3.interpolateRdYlGn(+linkAverage)+'">'+ linkAverage +'</span></td>'+
								'</tr></table></div>';
						}
						//html+="</table></div>";
						return html;
					});

					//setting dei tooltip (nodes)
					//esemplificativo
					tipNodes.html(function(d) 
					{
						var object = d3.entries(d),
							nodeName = object[0].value,
							nodeMean = (+medie[nodeName]).toFixed(4),
							html = "";
						var systems_dunnett = [];
						if(radioval() == "average")
						{
							systems_dunnett = dunnett(nodeName);
							systems_dunnett = systems_dunnett.sort(compare);
						}
						//var prec_array = [];
						
						var sistemi =top_ten(nodeName);

						//console.log(sistemi.length)

						if( sistemi.length > 0)
						{
							html = '<tr><td><h2>Best Path:</h2></td><td></td></tr>';
							
							html += '<tr>'+ //sistemi[index]
								'<td class="col-left">'+systems[sistemi[0]].components.toString()+'</td>'+
								'<td align="right"><span style="color:'+d3.interpolateRdYlGn(+systems[sistemi[0]].ap)+'">'+(+systems[sistemi[0]].ap).toFixed(4)+'</span></td>'+
								'</tr>';

							if( systems_dunnett.length > 0)
							{
								var index;
								html = html + '<tr><td><p style="margin-top: 2px; margin-bottom: 0px;"><strong>Top Group (Dunnett\'s test):</strong></p></td><td></td></tr>';
								for(index = 0; index<systems_dunnett.length; index++)
								{	
									if(index == 5)
									{
										html += '<td align="center"><p style="font-size: 80%; margin-top: 2px; margin-bottom: 0px;">First five results</p></td>';
										break;
									}

									html += '<tr>'+ //sistemi[index]
									'<td class="col-left">'+systems[systems_dunnett[index]].components.toString()+'</td>'+
									'<td align="right"><span style="color:'+d3.interpolateRdYlGn(+systems[systems_dunnett[index]].ap)+'">'+(+systems[systems_dunnett[index]].ap).toFixed(4)+'</span></td>'+
									'</tr>';

								}

							}
								
						
							//}
							//var mean = ap_mean(prec_array).toFixed(4);
							html = 
								'<table>'+ '<tr>'+
								'<td class="col-left"><strong>Average:</strong></td>'+
								'<td align="right"><span style="color:'+d3.interpolateRdYlGn(+nodeMean)+'">'+ nodeMean +'</span></td>'+
								'</tr>' + html;

						}
						

						//plot_dunnett(systems_dunnett);

						return '<div class="table-wrapper">'+
								'<h1>'+nodeName+'</h1>'+ html;
					});

					tipAP.html(function(d) 
					{
						var object = d3.entries(d),
							nodeName = object[0].value,
							html;

						var prec_array = [];
						
						var sistemi =top_ten(nodeName);

						html =  '<div class="table-wrapper">'+
								'<h1>'+selectedMeasure() + ": [" +nodeName+', ' + round2Fixed(+nodeName+0.04) + ')</h1>'+
								'<table>';
								
							//var sistemi = path_ap[nodeName];
												
						if( sistemi.length > 0)
						{
							html+= '<tr><td><h2>Best Path:</h2></td><td></td></tr>';
							
							//var index;
							/*
							for(index = 0; index<sistemi.length; index++)
							{
								if(index == 10)
								{
									html += '<tr>'+
									'<td align="center">...</td>'+
									'</tr>';
									break;
								} */
								html += '<tr>'+
								'<td class="col-left">'+systems[sistemi[0]].components.toString()+'</td>'+
								'<td align="right"><span style="color:'+d3.interpolateRdYlGn(+systems[sistemi[0]].ap)+'">'+(+systems[sistemi[0]].ap).toFixed(4)+'</span></td>'+
								'</tr>';

							//}
							
						}
						return html;

						

						
						
					});
					
					//console.log(graph);
					
					
					//assegnazione di nodi a link per il sankey
					sankey
						.nodes(graph.nodes)
						.links(graph.links)
						.layout(0);
					
					
					var titles = svg.append("text")
						.attr("class", "title1")


					var timeout;
					//aggiunta dei link
					link = svg.append("g").selectAll(".link")
						.data(graph.links)
					    .enter().append("path")
						.attr("class", "link")
						.attr("d", path) //attributo che definisce il path da seguire
						.attr("id", function(d,i){
        					//d.id = i;
        					return "link-"+i;
						}) //definizione id del link
						.attr("selected", "0")
						.attr("source", function(d){
							return d.source.name;
						})
						.attr("target", function(d){
							return d.target.name;
						})
						.style("stroke-width", function(d) { return Math.max(2, d.dy); }) //larghezza N.B. d.dy dipende dal valore "value"
						.sort(function(a,b) {return b.ty - a.ty; }) //ordinamento in base alla coordinata y del target (permette minori incroci)
				/*		.on('mousemove', function(event) {
							
							tipLinks
								.style("top", (d3.event.pageY - linkTooltipOffset) + "px")
								.style("left", function () {
								var left = (Math.max(d3.event.pageX - linkTooltipOffset, 100)); 
								
								left = Math.min(left, window.innerWidth - $('.d3-tip').width() - 20)
								return left + "px"; })
							})*/
						.on('mouseover', function(d, event) {
								highlighting_path_over_link(d);
								var page_y = d3.event.pageY;
								var page_x = d3.event.pageX;
								var context = this;
								var args = [].slice.call(arguments);
								args.push(this);
								clearTimeout(timeout);
								timeout = setTimeout(function() {
									tipLinks.show.apply(context, args).style("top", (page_y + linkTooltipOffset +5) + "px")
									.style("left", function () {
										var left = (Math.max(page_x - linkTooltipOffset, 100)); 

										//console.log(window.innerWidth - $('.d3-tip').width() - 20)
										//console.log($('.d3-tip').width())
										//console.log(left)

										left = Math.min(left, window.innerWidth - 300 - 20)
										return left + "px"; })
									
								}, 300);

								//tipLink;
								
								
						})
						
						
						
						
						//function(d) {
						//	tipLinks.show(d);
						//	highlighting_path_over_link(d);
						//})
						.on('mouseout', function(d) {
							clearTimeout(timeout);
							tipLinks.hide(d);
							path_out_link(d);
						});
						//.on("mouseover", highlighting_path_over_link)
						//.on("mouseout", path_out_link);
					
					//aggiunta dei nodi									
					var node = svg.append("g").selectAll(".node")
							.data(graph.nodes)
							.enter().append("g")
							.attr("class", "node visible")
							.attr("transform", function(d) {  //i nodi vengono posizionati in successioni corrette
								return "translate(" + d.x + "," + d.y + ")"; })
							.attr("id", function(d){
								return d.name;
							})
							.attr("component", function(d){
								return d.component;
							})
							/*.on('mousemove', function(event) {

								tipNodes
								.style("top", (d3.event.pageY - $('.d3-tip-nodes').height() - 20) + "px")
								.style("left", function () {
									var left = (Math.max(d3.event.pageX - nodeTooltipOffset, 10)); 
									left = Math.min(left, window.innerWidth - $('.d3-tip').width() - 150)
									return left + "px"; })
								})*/
							//.transition().delay(200)
							.on('mouseover', function(d) {
								if(isNaN(+d.name))
								{
									
									var page_x = d3.event.pageX;
									//console.log(d);
									var context = this;
									var args = [].slice.call(arguments);
									args.push(this);
									clearTimeout(timeout);
									timeout = setTimeout(function() {
										tipNodes.show.apply(context, args)//.style("top", (page_y - linkTooltipOffset) + "px")
										.style("left", function () {
										var left = page_x-10; 
										left = Math.min(left, window.innerWidth - $('.d3-tip').width() - 20)
										return left + "px"; })
									}, 300);
								}
								else
								{
									//console.log(d);
									var context = this;
									var args = [].slice.call(arguments);
									args.push(this);
									clearTimeout(timeout);
									timeout = setTimeout(function() {
										tipAP.show.apply(context, args);
									}, 300);

								}
							})
							//tipNodes.show)
							.on('mouseout', function(d){
								clearTimeout(timeout);
								tipNodes.hide(d);
								tipAP.hide(d);
							});

					node.filter(function(d) { return (precision_nodes.indexOf(d.name) == -1); })
							.call(d3.behavior.drag() //spostamento dei nodi
								.origin(function(d) { return d; })
								.on("dragstart", function() { 
										flag = true;
								})
							//			this.parentNode.appendChild(this); })
								.on("drag", dragmove)
								.on("dragend", dragfinish)); //da definire
						  
					node.append("rect") //nodi = rettangoli
					  .attr("height", function(d) { return d.dy; }) //altezza d.dy
					  .attr("width", function(d) { return d.dx; }) // larghezza dei nodi = 3
					  .style("fill", function(d) { 
						  if(selected_stem.indexOf(d.name) != -1 || selected_model.indexOf(d.name) != -1 || selected_stop.indexOf(d.name) != -1)
						  {
							return d.color = colorScheme[d.name];//color(d.name.replace(/ .*/, "")); //colore dei nodi non AP (scelto in base al nome)
						  }
						  else{
						  	return d.color = d3.interpolateRdYlGn((+d.name).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)); } //colore nodi AP
					  	  })
					  .style("stroke", function(d) { 
						  return d3.rgb(d.color).darker(2); }) //bordo più scuro
					  .attr("node-selected", 0)
					  .attr("name", function(d) {return d.name;})
					  .on("click", highlighting_path_node) 
					  .on("mouseover",highlighting_path_over_node)
					  .on("mouseout", path_out_node); 
					
					//console.log(graph.nodes);

					// aggiunta dei "titoli" ai nodi
					node.append("text")
						  //.attr("fill", "#EFEFEF")
						  .attr("visibility", "visible")
						  .attr("x", -6)
						  .attr("y", function(d) { 	if(precision_nodes.indexOf(d.name) != -1)
													{
														//console.log(d.name);
														return 0;
													}
													else
														return d.dy/2; 
												 })
						  .attr("dy", ".35em")
						  .attr("text-anchor", "end")
						  .attr("transform", null)
						  .text(function(d) { return d.name; })
						  .filter(function(d) { return d.x < width / 2; })
						  .attr("x",6 + sankey.nodeWidth())
						  .attr("text-anchor", "start");


					node.filter(function (d) { return d.name === "0.96";})
         					//aggiungi l'1.00 all'ultimo valore di AP o MAP
         				.append("text")
						  //.attr("fill", "#EFEFEF")
						  .attr("visibility", "visible")
						  .attr("x", -6)
						  .attr("y", function(d) { 	return d.dy })
						  .attr("dy", ".35em")
						  .attr("text-anchor", "end")
						  .attr("transform", null)
						  .text("1.00")
						  .filter(function(d) { return d.x < width / 2; })
						  .attr("x",6 + sankey.nodeWidth())
						  .attr("text-anchor", "start");
			
					function dragmove(d) {
						if(flag)
						{
							this.parentNode.appendChild(this);
							flag = false;
						}
						//d3.event.sourceEvent.preventDefault();						
						d3.select(this).attr("transform", 
							"translate(" +  //(d.x = Math.max(0, Math.min(width - d.dx, d3.event.x))) (spostamento orizzontale)
								d.x + "," + (
								d.y = Math.max(0, Math.min(height - d.dy, d3.event.y)) //spostamento verticale
							) + ")");
						
						//sankey.relayout();
						//console.log(link.attr("d", path));
						link.attr("d", path); //permette di mantenere la connessione tramite link
						
					}

					//da definire
					function dragfinish(d) {
						//console.log(d);

						var sel = d3.select("#"+d.name);
						var currentx =  d3.transform(sel.attr("transform")).translate[0];

						//console.log(currentx); //'[id="'+node+'"]'

						var sameXNodes = d3.selectAll(".node").filter(function(e){
							//console.log(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0]);
							//console.log(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentx) 
							if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentx)
								return true;
							}) //d3.transform(sel.attr("transform")).translate[0];
						//console.log(prova);
						
						var y_coordinates = [];
						sameXNodes.each(function(e){
							y_coordinates.push([e, e.y, e.dy]);

						})
						//console.log(y_coordinates);

						y_coordinates = y_coordinates.sort(Comparator);
						//console.log(y_coordinates);

						var ndy = 0;

						y_coordinates.forEach(function(nodeToMove)
						{
							d3.select("#"+nodeToMove[0].name)
									.transition()
									.duration(700)
									.attr("transform", "translate(" + currentx + "," + (this.y = ndy) + ")"
										);
							var sel = d3.select("#"+nodeToMove[0].name);
							//console.log(sel[0]);
							sel.each(function(d){
									d.y=ndy;});
							//sel[0][0].__data__.y = ndy;
							//console.log(sel[0][0].__data__);
							//sel.each(function(d){console.log(d)})
							ndy = ndy+nodeToMove[2]+1;

						});

						sankey.relayout();
						link.transition().duration(700).attr("d", path);
						
						
					}

					function top_ten(component_name)
					{
						var invisible_links = d3.selectAll('.link').filter('.invisible');
						if(components["stoplist"].indexOf(component_name) != -1)
						{
							var systems_selected = path_stop[component_name];
							
							invisible_links.each(function(d){

								systems_selected = _.difference(systems_selected, path_link["link-"+d.id])
								//console.log(d.id);
							});
						}						
						else if(components["stemmer"].indexOf(component_name) != -1)
						{
							var systems_selected = path_stem[component_name];

							invisible_links.each(function(d){

								systems_selected = _.difference(systems_selected, path_link["link-"+d.id])
								//console.log(d.id);
							});
						}
						else if(components["model"].indexOf(component_name) != -1)
						{
							var systems_selected = path_model[component_name];

							invisible_links.each(function(d){

								systems_selected = _.difference(systems_selected, path_link["link-"+d.id])
								//console.log(d.id);
							});
						}
						else
						{
							var systems_selected = path_ap[component_name];

							invisible_links.each(function(d){

								systems_selected = _.difference(systems_selected, path_link["link-"+d.id])
								//console.log(d.id);
							});
						}
						
						systems_selected.sort(compare);

						return systems_selected;

					}

					function top_ten_link(link_name)
					{
						var systems_selected = path_link[link_name];
						var invisible_links = d3.selectAll('.link').filter('.invisible');
						invisible_links.each(function(d){

							systems_selected = _.difference(systems_selected, path_link["link-"+d.id])
							//console.log(d.id);
						});
						systems_selected.sort(compare);

						return systems_selected;
					}

					

					if(actualSelectedNodes.length > 0)
					{
						//console.log(actualSelectedNodes)
						actualSelectedNodes.forEach(function(node)
						{

							var actualNode = d3.select("[name='"+node+"']");
							//console.log(actualNode);
							var slinks;
							var tlinks;

							actualNode.each(function(d){
									slinks = d.sourceLinks;
									tlinks = d.targetLinks;
								});
							//console.log(actualNode[0][0].__data__);
							
							//console.log(d3.select("[name='"+node+"']"));

							//console.log(d3.select("#"+node.name));
							if(slinks.length != 0 || tlinks.length != 0)
							{
								d3.select("[name='"+node+"']").attr("node-selected","1")
										.style("filter", "brightness(400%)")
										.style("fill", "yellow");
							}
						});

						var selected_nodes = d3.selectAll("[node-selected='1']")[0];
						var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
							if(!isNaN(+d.name))
								return true;
						})[0];	

						var sel_model = [];
						var sel_stem = [];
						var sel_stop = [];
						var sel_ap = [];

						var names_selected_nodes = [];
						selected_nodes.forEach(function(d)
						{
							names_selected_nodes.push(d.parentNode.id);
						
							
							if(selected_model.indexOf(d.parentNode.id) != -1)
							{
								sel_model.push(paths[d.parentNode.id]);
							}
							else if(selected_stem.indexOf(d.parentNode.id) != -1)
							{
								sel_stem.push(paths[d.parentNode.id]);
							}
							else if(selected_stop.indexOf(d.parentNode.id) != -1)
							{
								//console.log(d.parentNode.id);
								//console.log(paths[d.parentNode.id]);
								sel_stop.push(paths[d.parentNode.id]);
							}
							else
							{
								sel_ap.push(paths[d.parentNode.id]);
							}
						});

						var union_model = _.union.apply(_, sel_model);
						var union_stop = _.union.apply(_, sel_stop);
						var union_stem = _.union.apply(_, sel_stem);
						var union_ap =  _.union.apply(_, sel_ap);
						var union_test = [];
						
						if(union_model.length != 0)
						{
							union_test.push(union_model);
						}
						if(union_stop.length != 0)
						{
							union_test.push(union_stop);
						}
						if(union_stem.length != 0)
						{
							union_test.push(union_stem);
						}
						if(union_ap.length != 0)
						{
							union_test.push(union_ap);
						}
						//console.log(union_model);

						//console.log(union_test);
						var commons = _.intersection.apply(_, union_test);
						
						//console.log(sel_model);
						//console.log(sel_stop);
						//console.log(sel_stem);
						//console.log(commons);
					
						d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
						
						
						
						
						var commons2 = [];

						commons.forEach(function(d,i)
						{	
							//console.log(systems[d].path[0]);
							var link1 = d3.select("#link-"+systems[d].path[0]);
							//console.log(link1.attr("class"));
							var link2 = d3.select("#link-"+systems[d].path[1]);
							var link3 = d3.select("#link-"+systems[d].path[2]);
							if(radioLinkVal() == "node-based")
							{
								
								if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
								{
									commons2.push(d);
									d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
									d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", "" +colorScheme[link2.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
									d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
								}
								else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
								{
									commons2.push(d);
									link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
									link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								}
							}
							else
							{
								if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
								{
									//console.log(link1.attr("source"));
									commons2.push(d);
									link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
									link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								}
							}
						});

						if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
							update_link_color(commons2);

						//update_link_color(commons2);
					}
					
					if(actualInvisibleNodes.length > 0)
					{
						actualInvisibleNodes.forEach(function(node)
						{
							//$("input:checkbox[value="+node+"]").click();
							$('#'+node).removeClass('visible').addClass('invisible');
							$('#'+node).children('text').removeClass('visible').addClass('invisible');
							var systems_selected = paths[node];
							var typeC = $('#'+node).attr('component');

							systems_selected.forEach(function(d,i)
							{	
								//console.log(systems[d].path[0]);
								
								$("#link-"+systems[d].path[0]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible').attr('selected', '0');
								$("#link-"+systems[d].path[1]).attr('selected', '0');
								$("#link-"+systems[d].path[2]).attr('selected', '0');
								
								var firstcomp = d3.select("[position='1']")[0][0].id,
									thirdcomp = d3.select("[position='3']")[0][0].id;

								if(typeC == firstcomp)
								{
									$('#link-'+systems[d].path[1]).css('stroke-opacity', .3).css('stroke', 'black');
									$('#link-'+systems[d].path[2]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
									
								}
								else if(typeC == thirdcomp)
								{
									$('#link-'+systems[d].path[1]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
									$('#link-'+systems[d].path[2]).css('stroke-opacity', .3).css('stroke', 'black');
								}
								else
								{
									$('#link-'+systems[d].path[1]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
									$('#link-'+systems[d].path[2]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
								}


							});

						});

						change_checkbox_at_start(actualInvisibleNodes[0]);

						

					}
					

					
					
						
				});
					
			
				


				//console.log(radioval());
				

				//la funzione evidenzia i path al quale un certo nodo partecipa
				//nel momento in cui il nodo viene cliccato

				function highlighting_path_node(node,i)
				{
					//test();
					if (d3.event.defaultPrevented) return;
					

					if(precision_nodes.indexOf(node.name) != -1)
					{
						if(precision_active_nodes.indexOf(node.name) == -1)
						{
							alert("Nessun sistema ha un valore di "+ selectedMeasure() +" compreso nell'intervallo \n [" + node.name +", " + round2Fixed((+node.name+0.04)) +")");
							return;
						}
					}
					
					if(d3.select(this).attr("node-selected") == "0")
					{
						
						//console.log(node);
						actualSelectedNodes.push(node.name);
						//console.log(actualSelectedNodes);
						//dunnett(node.name);
						var selected_nodes = d3.selectAll("[node-selected='1']")[0];
						

						if(selected_nodes.length == 0)
						{
							d3.select(this).attr("node-selected","1")
										.style("filter", "brightness(400%)")
										.style("fill", "yellow");
							
							var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
								if(!isNaN(+d.name))
									return true;
							})[0];	
								
							//console.log(selected_nodes_measure);
							
							var systems_selected = paths[node.name];
							//colore dei link in base alla media dei valori di AP/MAP
							var commons2 = [];
							systems_selected.forEach(function(d,i)
							{	
								
								//console.log(systems[d].path[0]);
								var link1 = d3.select("#link-"+systems[d].path[0]);
								//console.log(link1.attr("class"));
								var link2 = d3.select("#link-"+systems[d].path[1]);
								var link3 = d3.select("#link-"+systems[d].path[2]);
								if(radioLinkVal() == "node-based")
								{
									if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										//console.log(link1.attr("source"));
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link2.style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link2.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
									else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
								}
								else
								{
									if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										//console.log(link1.attr("source"));
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}

								}
							});

							if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
								update_link_color(commons2);

							
						}

						//var names_selected_nodes = [];
						else if(selected_nodes.length != 0)
						{ 	
							var sel_model = [];
							var sel_stem = [];
							var sel_stop = [];
							var sel_ap = [];
							
							var systems_selected = paths[node.name];
							if(selected_model.indexOf(node.name) != -1)
							{
								sel_model.push(paths[node.name]);
							}
							else if(selected_stem.indexOf(node.name) != -1)
							{
								sel_stem.push(paths[node.name]);
							}
							else if(selected_stop.indexOf(node.name) != -1)
							{
								sel_stop.push(paths[node.name]);
							}
							else
							{
								sel_ap.push(paths[node.name]);
							}


							var names_selected_nodes = [];
							selected_nodes.forEach(function(d)
							{
								names_selected_nodes.push(d.parentNode.id);
							
								
								if(selected_model.indexOf(d.parentNode.id) != -1)
								{
									sel_model.push(paths[d.parentNode.id]);
								}
								else if(selected_stem.indexOf(d.parentNode.id) != -1)
								{
									sel_stem.push(paths[d.parentNode.id]);
								}
								else if(selected_stop.indexOf(d.parentNode.id) != -1)
								{
									//console.log(d.parentNode.id);
									//console.log(paths[d.parentNode.id]);
									sel_stop.push(paths[d.parentNode.id]);
								}
								else
								{
									sel_ap.push(paths[d.parentNode.id]);
								}
							});

							var union_model = _.union.apply(_, sel_model);
							var union_stop = _.union.apply(_, sel_stop);
							var union_stem = _.union.apply(_, sel_stem);
							var union_ap =  _.union.apply(_, sel_ap);
							var union_test = [];
							
							if(union_model.length != 0)
							{
								union_test.push(union_model);
							}
							if(union_stop.length != 0)
							{
								union_test.push(union_stop);
							}
							if(union_stem.length != 0)
							{
								union_test.push(union_stem);
							}
							if(union_ap.length != 0)
							{
								union_test.push(union_ap);
							}
							//console.log(union_model);

							//console.log(union_test);
							var commons = _.intersection.apply(_, union_test);
							
							//console.log(sel_model);
							//console.log(sel_stop);
							//console.log(sel_stem);
							//console.log(commons);
						
							d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
							
							d3.select(this).attr("node-selected","1")
								.style("filter", "brightness(400%)")
								.style("fill", "yellow");
							
							var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
								if(!isNaN(+d.name))
									return true;
							})[0];
							
							var commons2 = [];

							commons.forEach(function(d,i)
							{	
								//console.log(systems[d].path[0]);
								var link1 = d3.select("#link-"+systems[d].path[0]);
								//console.log(link1.attr("class"));
								var link2 = d3.select("#link-"+systems[d].path[1]);
								var link3 = d3.select("#link-"+systems[d].path[2]);
								if(radioLinkVal() == "node-based")
								{
									
									if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										commons2.push(d);
										d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
										d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", "" +colorScheme[link2.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
										d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
									}
									else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
								}
								else
								{
									if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										//console.log(link1.attr("source"));
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
								}
							});

							if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
								update_link_color(commons2);

							//update_link_color(commons2);
							

						}
					}
					else
					{
						actualSelectedNodes = actualSelectedNodes.filter(function(item) { 
							return item !== node.name;
						});

						//console.log(actualSelectedNodes);
						d3.select(this).attr("node-selected","0")
										.style("filter", "brightness(100%)")
										.style("fill", function(d){
											if(selected_model.indexOf(d.name)!=-1 || selected_stem.indexOf(d.name)!=-1 || selected_stop.indexOf(d.name)!=-1)
												return d.color = colorScheme[d.name];//color(d.name.replace(/ .*/, ""));
											else
												return d.color = d3.interpolateRdYlGn((+d.name).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00));
										});
						var selected_nodes = d3.selectAll("[node-selected='1']")[0];

						var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
								if(!isNaN(+d.name))
									return true;
							})[0];	

						if(selected_nodes.length == 0)
						{
							d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
						}
						else if(selected_nodes.length == 1)
						{
							d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
							var names_selected_node = selected_nodes[0].parentNode.id;
							var systems_selected = paths[names_selected_node];
							var commons2 = [];
							systems_selected.forEach(function(d,i)
							{	
								//console.log(systems[d].path[0]);
								var link1 = d3.select("#link-"+systems[d].path[0]);
								//console.log(link1.attr("class"));
								var link2 = d3.select("#link-"+systems[d].path[1]);
								var link3 = d3.select("#link-"+systems[d].path[2]);
								if(radioLinkVal() == "node-based")
								{

									if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										commons2.push(d);
										d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke",  ""+colorScheme[link1.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
										d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke",  ""+colorScheme[link2.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
										d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke",  ""+colorScheme[link3.attr("source")]).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
									}
									else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
								}
								else
								{
									if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										//console.log(link1.attr("source"));
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
								}
							});

							if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
								update_link_color(commons2);
						}
						else
						{
							var sel_model = [];
							var sel_stem = [];
							var sel_stop = [];
							var sel_ap = [];
							
							var names_selected_nodes = [];
							selected_nodes.forEach(function(d)
							{
								names_selected_nodes.push(d.parentNode.id);

								if(selected_model.indexOf(d.parentNode.id) != -1)
								{
									sel_model.push(paths[d.parentNode.id]);
								}
								else if(selected_stem.indexOf(d.parentNode.id) != -1)
								{
									sel_stem.push(paths[d.parentNode.id]);
								}
								else if(selected_stop.indexOf(d.parentNode.id) != -1)
								{
									//console.log(d.parentNode.id);
									//console.log(paths[d.parentNode.id]);
									sel_stop.push(paths[d.parentNode.id]);
								}
								else
								{
									sel_ap.push(paths[d.parentNode.id]);
								}
							});

							var union_model = _.union.apply(_, sel_model);
							var union_stop = _.union.apply(_, sel_stop);
							var union_stem = _.union.apply(_, sel_stem);
							var union_ap = _.union.apply(_, sel_ap);
							var union_test = [];
							
							if(union_model.length != 0)
							{
								union_test.push(union_model);
							}
							if(union_stop.length != 0)
							{
								union_test.push(union_stop);
							}
							if(union_stem.length != 0)
							{
								union_test.push(union_stem);
							}
							if(union_ap.length != 0)
							{
								union_test.push(union_ap);
							}

							var commons = _.intersection.apply(_, union_test);
							
							/*if(names_selected_nodes.length>2)
							{
								for(i=2;i<names_selected_nodes.length;i++)
								{
									commons = _.intersection(commons, paths[names_selected_nodes[i]])
								}

							}*/

							d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
							var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
								if(!isNaN(+d.name))
									return true;
							})[0];	


							var commons2 = [];							
							commons.forEach(function(d,i)
							{	
								//console.log(systems[d].path[0]);
								var link1 = d3.select("#link-"+systems[d].path[0]);
								//console.log(link1.attr("class"));
								var link2 = d3.select("#link-"+systems[d].path[1]);
								var link3 = d3.select("#link-"+systems[d].path[2]);
								if(radioLinkVal() == "node-based")
								{
								
									if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{

										commons2.push(d);
										d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
										d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link2.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
										d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
									
									}
									else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
								}								
								else
								{
									if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										//console.log(link1.attr("source"));
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
								}
							});

							if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
								update_link_color(commons2);

						}

					}

				}




				//la funzione evidenzia i path al quale un certo nodo partecipa
				//nel momento in cui il puntatore del mouse passa sul nodo

				function highlighting_path_over_node(node,i)
				{
					var systems_selected = paths[node.name];
					

					systems_selected.forEach(function(d,i)
					{	
						//console.log(systems[d].path[0]);
						var link1 = d3.select("#link-"+systems[d].path[0]);
						//console.log(link1.attr("class"));
						var link2 = d3.select("#link-"+systems[d].path[1]);
						var link3 = d3.select("#link-"+systems[d].path[2]);
						if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
						{
							if(d3.select("#link-"+systems[d].path[0]).attr("selected") != "1")
							{
								d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".6").style("stroke", function(){
												if(radioLinkVal() == "node-based")
												{
													if(selected_model.indexOf(node.name)!=-1 || selected_stem.indexOf(node.name)!=-1 || selected_stop.indexOf(node.name)!=-1)
														return  colorScheme[link1.attr("source")]//colorScheme[node.name];//color(node.name.replace(/ .*/, ""));
													else
														return d3.interpolateRdYlGn((+node.name).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00));
												}
												

											});
							}
							else
							{
								d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".6");
							}
							if(d3.select("#link-"+systems[d].path[1]).attr("selected") != "1")
							{
								d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".6").style("stroke", function(){
												if(radioLinkVal() == "node-based")
												{	
													if(selected_model.indexOf(node.name)!=-1 || selected_stem.indexOf(node.name)!=-1 || selected_stop.indexOf(node.name)!=-1)
															return colorScheme[link2.attr("source")];//colorScheme[node.name];//color(node.name.replace(/ .*/, ""));
														else
															return d3.interpolateRdYlGn((+node.name).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00));
												}
											});
							}	
							else
							{
								d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".6");
							}
							if(d3.select("#link-"+systems[d].path[2]).attr("selected") != "1")
							{
								d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".6").style("stroke", function(){
												if(radioLinkVal() == "node-based")
												{	
													if(selected_model.indexOf(node.name)!=-1 || selected_stem.indexOf(node.name)!=-1 || selected_stop.indexOf(node.name)!=-1)
														return colorScheme[link3.attr("source")];//colorScheme[node.name];//color(node.name.replace(/ .*/, ""));
													else
														return d3.interpolateRdYlGn((+node.name).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00));
												}
											});
							}
							else
							{
								d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".6");
							}
						}
					});

				}

				//quando il puntatore "esce" dal nodo i path precedentemente
				//evidenziati con la funzione highlighting_path_over tornano
				//allo stato standard

				function path_out_node(node,i)
				{
					if(d3.select(this).attr("node_selected") != "1")
					{
						var systems_selected = paths[node.name];

						systems_selected.forEach(function(d,i)
						{	
							if(d3.select("#link-"+systems[d].path[0]).attr("selected") != "1")
							{	
								d3.select("#link-"+systems[d].path[0]).style("stroke", "black").style("stroke-opacity", ".2");
								//d3.select("#link-"+d[1]).style("stroke-opacity", ".2");
								//d3.select("#link-"+d[2]).style("stroke-opacity", ".2");
							}
							else
							{
								d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3");
							}
							if(d3.select("#link-"+systems[d].path[1]).attr("selected") != "1")
							{
								d3.select("#link-"+systems[d].path[1]).style("stroke", "black").style("stroke-opacity", ".2");
							
							}
							else
							{
								d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3");
							}
							if(d3.select("#link-"+systems[d].path[2]).attr("selected") != "1")
							{
								d3.select("#link-"+systems[d].path[2]).style("stroke", "black").style("stroke-opacity", ".2");
							}
							else
							{
								d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3");
							}
						});

					}
				}

				//evidenzia i path ai quali un link partecipa
				//quando viene passato il puntatore sopra il link

				function highlighting_path_over_link(link,i)
				{
					

					var paths_to_highlight = list_of_path["link-"+link.id];

					if(paths_to_highlight != undefined)
					{
						paths_to_highlight.forEach(function(d,i)
						{	
	
							d3.select("#link-"+d[0]).style("stroke-opacity", ".6");
							d3.select("#link-"+d[1]).style("stroke-opacity", ".6");
							d3.select("#link-"+d[2]).style("stroke-opacity", ".6");

						});

					}

				}

				function path_out_link(link,i)
				{
					
					
						var paths_to_highlight = list_of_path["link-"+link.id];

						paths_to_highlight.forEach(function(d,i)
						{	
							if(d3.select("#link-"+d[0]).attr("selected") != "1")
							{	
								d3.select("#link-"+d[0]).style("stroke-opacity", ".2");
								//d3.select("#link-"+d[1]).style("stroke-opacity", ".2");
								//d3.select("#link-"+d[2]).style("stroke-opacity", ".2");
							}
							else
							{
								d3.select("#link-"+d[0]).style("stroke-opacity", ".3");
							}
							if(d3.select("#link-"+d[1]).attr("selected") != "1")
							{
								d3.select("#link-"+d[1]).style("stroke-opacity", ".2");
							
							}
							else
							{
								d3.select("#link-"+d[1]).style("stroke-opacity", ".3");
							}
							if(d3.select("#link-"+d[2]).attr("selected") != "1")
							{
								d3.select("#link-"+d[2]).style("stroke-opacity", ".2");
							}
							else
							{
								d3.select("#link-"+d[2]).style("stroke-opacity", ".3");
							}
								//"link-"+d.id
						});

				}

				$( function() {
					$('li').tipsy({ 
						gravity: 'w', 
						opacity: 0.96,
						html: true, 
						title: function() {

							var test = this.childNodes[0].childNodes[0].firstChild.data;
							var data = metadata.track[test.substring(5,)];
							
							if(data != undefined)
							{
								var html= "NAME:"+data.name+"<br/>YEAR:"+data.year+"<br/>TYPE:"+data.type+"<br/>CORPUS:<br/> &nbsp&nbsp&nbsp   NAME:"+data.corpus.name
								+"<br/> &nbsp&nbsp&nbsp   DOCUMENTS:"+data.corpus.documents+"<br/>  &nbsp&nbsp&nbsp  LANGUAGE:"+data.corpus.language+"<br/>TOPIC:<br/> &nbsp&nbsp&nbsp  SET:"+data.topic.set+"<br/> &nbsp&nbsp&nbsp  LANGUAGE:"+data.topic.language
								+"<br/>GROUND TRUTH:<br/> &nbsp&nbsp&nbsp  RELEVANCE:"+data.groundTruth.relevance+"<br/>  &nbsp&nbsp&nbsp  POOLING:"+data.groundTruth.pooling;
								//  +"<br/>OVERVIEW:<br/>   &nbsp&nbsp&nbsp 	REFERENCE:"+data.overview.reference+"<br/> &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp"+ref_half+"<br/> &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp"+ref_last+"<br/>   &nbsp&nbsp&nbsp LINK:"+overview.link;
								return html; 
							}
							else
								return test;
						}
					});
				});
				
				
				setTimeout(hide, 800);

				
				
			}





			$('#normalization input').each(function(){
						$(this).prop('checked', false);
					//console.log($(this).prop('checked', val));
					//console.log(this);
					});

			$('#Radio4').prop('checked', true);
			
			$('#Radio1').prop('checked', true);
			$('#Radio5').prop('checked', true);
			
			/*
			selectAll("stemmer", true, false);
			selectAll("stoplist", true, false);
			selectAll("model", true, false);
			actualInvisibleNodes = [];*/
			
			if(radioval()=="average")
				$("#topic_form").removeClass("visible").addClass("invisible");
			
			
			
  			//document.getElementById("myDiv").style.display = "block";
			generateSankey();
			
			
			// $.when(generateSankey()).then(normalization(precision_active_nodes, precision_nodes, true));
			
			  
			
			

			//console.log(components);
			





			//In base ai nodi selezionati, evidenzia e colora i link

			function link_color(delay)
			{
				if(delay == undefined)
					delay=0;
				var selected_nodes = d3.selectAll("[node-selected='1']")[0];
				if(selected_nodes.length != 0)
				{
					var sel_model = [];
					var sel_stem = [];
					var sel_stop = [];
					var sel_ap = [];
					
					var names_selected_nodes = [];
					selected_nodes.forEach(function(d)
					{
						if(d.parentNode.classList[1] == "visible")
						{
							names_selected_nodes.push(d.parentNode.id);

							if(components["model"].indexOf(d.parentNode.id) != -1)
							{
								sel_model.push(paths[d.parentNode.id]);
							}
							else if(components["stemmer"].indexOf(d.parentNode.id) != -1)
							{
								sel_stem.push(paths[d.parentNode.id]);
							}
							else if(components["stoplist"].indexOf(d.parentNode.id) != -1)
							{
								//console.log(d.parentNode.id);
								//console.log(paths[d.parentNode.id]);
								sel_stop.push(paths[d.parentNode.id]);
							}
							else
							{
								sel_ap.push(paths[d.parentNode.id]);
							}
						}
					});

					//console.log(sel_model, sel_stem, sel_stop, sel_ap, names_selected_nodes);

					var union_model = _.union.apply(_, sel_model);
					var union_stop = _.union.apply(_, sel_stop);
					var union_stem = _.union.apply(_, sel_stem);
					var union_ap = _.union.apply(_, sel_ap);
					var union_test = [];
					
					if(union_model.length != 0)
					{
						union_test.push(union_model);
					}
					if(union_stop.length != 0)
					{
						union_test.push(union_stop);
					}
					if(union_stem.length != 0)
					{
						union_test.push(union_stem);
					}
					if(union_ap.length != 0)
					{
						union_test.push(union_ap);
					}

					//console.log(union_test);

					var commons = _.intersection.apply(_, union_test);
					
					/*
					if(names_selected_nodes.length>2)
					{
						for(i=2;i<names_selected_nodes.length;i++)
						{
							commons = _.intersection(commons, paths[names_selected_nodes[i]])
						}

					}
					*/
					d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
					var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
								if(!isNaN(+d.name))
									return true;
							})[0];	
					var commons2 = [];
					commons.forEach(function(d,i)
					{	
						//console.log(systems[d].path[0]);
						var link1 = d3.select("#link-"+systems[d].path[0]);
						//console.log(link1.attr("class"));
						var link2 = d3.select("#link-"+systems[d].path[1]);
						var link3 = d3.select("#link-"+systems[d].path[2]);
						if(radioLinkVal() == "node-based")
						{
						
							if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
							{

								commons2.push(d);
								d3.select("#link-"+systems[d].path[0]).transition().delay(delay).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
								d3.select("#link-"+systems[d].path[1]).transition().delay(delay).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link2.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
								d3.select("#link-"+systems[d].path[2]).transition().delay(delay).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
							
							}
							else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
							{
								commons2.push(d);
								link1.style("stroke-opacity", ".3").transition().delay(delay).style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
								link2.style("stroke-opacity", ".3").transition().delay(delay).style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								link3.style("stroke-opacity", ".3").transition().delay(delay).style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
							}
						}								
						else
						{
							if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
							{
								//console.log(link1.attr("source"));
								commons2.push(d);
								link1.style("stroke-opacity", ".3").transition().delay(delay).style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
								link2.style("stroke-opacity", ".3").transition().delay(delay).style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								link3.style("stroke-opacity", ".3").transition().delay(delay).style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
							}
						}
					});

					if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
						update_link_color(commons2);
					

				/*	commons.forEach(function(d,i)
					{	
						//console.log(systems[d].path[0]);
						var link1 = d3.select("#link-"+systems[d].path[0]);
						//console.log(link1.attr("class"));
						var link2 = d3.select("#link-"+systems[d].path[1]);
						var link3 = d3.select("#link-"+systems[d].path[2]);
						if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
						{
							commons2.push(d);
							d3.select("#link-"+systems[d].path[0]).transition().delay(delay).style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1");
							d3.select("#link-"+systems[d].path[1]).transition().delay(delay).style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1");
							d3.select("#link-"+systems[d].path[2]).transition().delay(delay).style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1");
						}
					});

					update_link_color(commons2); */
				}
			}




			//Aggiornamento dei colori dei link in base alla media dei
			//valori di AP/MAP puntati

			function update_link_color(commons)
			{
				var link_selected = d3.selectAll("[selected='1']")[0];
				var link_selected_name = [];
				
				link_selected.forEach(function(d)
				{
					var new_commons =  _.intersection(commons, path_link[d.id]);
					var list_of_prec = [];
					new_commons.forEach(function(e)
					{
						list_of_prec.push(systems[e].apCluster);
					});
					var media = ap_mean(list_of_prec);

					d3.select("#"+d.id).style("stroke", d3.interpolateRdYlGn((+media).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)));

					//console.log(""+d.id+ " media: "+media);

				});

			}

			//calcolo della media valori presenti in un array
			//usato in "update_link_color"

			function ap_mean(ap_array)
			{
				var sum_prec = ap_array.reduce(add, 0);

				return (+sum_prec)/ap_array.length;
			}
			

			//deseleziona tutti i nodi selezionati del Sankey
			// premendo il tasto "Reset Nodes Selection"

			function resetSelection()
			{
				actualSelectedNodes = [];
				d3.selectAll("[node-selected='1']").attr("node-selected", "0")
										.style("filter", "brightness(100%)")
										.style("fill", function(d){
											if(selected_model.indexOf(d.name)!=-1 || selected_stem.indexOf(d.name)!=-1 || selected_stop.indexOf(d.name)!=-1)
												return d.color = colorScheme[d.name];//color(d.name.replace(/ .*/, ""));
											else
												return d.color = d3.interpolateRdYlGn((+d.name).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00));
										});

				d3.selectAll("[selected='1']").attr("selected","0").style("stroke-opacity", ".2").style("stroke","black");




			}

			//la funzione si occupa di rendere visibili o invisibili
			//nodi e link coinvolti da un click sui tasti
			//"select all" e "deselect all"
			function visible(type, val, val2)
			{
				var components = {"stoplist": ["indri","lucene","nostop","smart","snowball","terrier"], 
				"stemmer": ["krovetz","lovins","nolug","porter","snowballPorter","weakPorter"],
				"model": ["bb2","bm25","dfiz","dfree","dirichletlm","dlh","dph","hiemstralm","ifb2","inb2","inexpb2","inl2","jskls","lemurtfidf","lgd","pl2","tfidf"]
				};

				d3.selectAll("."+type+"box").each(function() {
		  
					if(val) 
						d3.select(this).property("checked", true);
					else
						d3.select(this).property("checked", false);	
				});

				if(val)
				{
					components[type].forEach(function(name)
					{
						$('#'+name).removeClass('invisible').addClass('visible');
						$('#'+name).children('text').removeClass('invisible').addClass('visible');
						if(actualInvisibleNodes != undefined)
						{
							actualInvisibleNodes = actualInvisibleNodes.filter(function(item) { 
								return item !== name;
							});	
						}
						
						

					});

					var all_visible = d3.selectAll("g").filter(".visible");
					//console.log(all_visible);
					var vis_model = [];
					var vis_stem = [];
					var vis_stop = [];
					all_visible[0].forEach(function(d)
					{
						if(selected_model.indexOf(d.id) != -1)
						{
							vis_model.push(paths[d.id]);
						}
						else if(selected_stem.indexOf(d.id) != -1)
						{
							vis_stem.push(paths[d.id]);
						}
						else if(selected_stop.indexOf(d.id) != -1)
						{
							vis_stop.push(paths[d.id]);
						}
					});

					var union_vis_model = _.union.apply(_, vis_model);
					var union_vis_stop = _.union.apply(_, vis_stop);
					var union_vis_stem = _.union.apply(_, vis_stem);
					var union_test = [];
					
					if(union_vis_model.length != 0)
					{
						union_test.push(union_vis_model);
					}
					if(union_vis_stop.length != 0)
					{
						union_test.push(union_vis_stop);
					}
					if(union_vis_stem.length != 0)
					{
						union_test.push(union_vis_stem);
					}
					//console.log(union_inv_stop);
					//console.log(union_test);
					if(union_test.length == 3)
					{
						var union_vis = _.union.apply(_, union_test);

						var commons_vis = _.intersection.apply(_, union_test);
					
						commons_vis.forEach(function(d,i)
						{	
							//console.log(systems[d].path[0]);
							$("#link-"+systems[d].path[0]).removeClass('invisible').addClass('visible');
							$("#link-"+systems[d].path[1]).removeClass('invisible').addClass('visible');
							$("#link-"+systems[d].path[2]).removeClass('invisible').addClass('visible');
						});
					}
					if(val2)
					{
						var firstName = components[type][0];

						var component = d3.select("#"+firstName).attr("component");
						//console.log(component);

						var nodeToEdit = d3.selectAll(".node")
						/*.filter(function(e)
						{
							if(e.component != component && e.component != undefined)
								return true;
						});*/

						

						nodeToEdit.each(function(node)
						{
							node.apMean = new_media(node.name).toFixed(4);
							medie[node.name] = +(new_media(node.name)).toFixed(4);
							if(components["stoplist"].indexOf(node.name) != -1)
							{
								node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stop;
								node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stop;
								if(node.height < 30)
								{
									node.height = 30;
								}
								else if(node.height > 182)
								{
									node.height = 182;
								}

								if(node.width < 9)
								{
									node.width = 9;
								}
								else if(node.width > 25)
								{
									node.width = 25;
								}
								node.dy = node.height;
								node.dx = node.width;
							}
							else if(components["stemmer"].indexOf(node.name) != -1)
							{
								node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stem;
								node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stem;
								if(node.height < 30)
								{
									node.height = 30;
								}
								else if(node.height > 182)
								{
									node.height = 182;
								}

								if(node.width < 9)
								{
									node.width = 9;
								}
								else if(node.width > 25)
								{
									node.width = 25;
								}
								node.dy = node.height;
								node.dx = node.width;
							}

							else if(components["model"].indexOf(node.name) != -1)
							{
								node.height = ((+node.apMean+0.0002).toFixed(4)*47)/max_media_modelli;
								node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_modelli;
								if(node.height < 30)
								{
									node.height = 30;
								}
								else if(node.height > 65)
								{
									node.height = 65;
								}

								if(node.width < 9)
								{
									node.width = 9;
								}
								else if(node.width > 25)
								{
									node.width = 25;
								}
								node.dy = node.height;
								node.dx = node.width;
							}
						});

						
						//console.log(nodeToPrint);
						var linksUpdate = d3.selectAll(".link").filter(function(e)
						{
							//console.log(e);
							if(components["stoplist"].indexOf(e.target.name) != -1 || components["stemmer"].indexOf(e.target.name) != -1 || components["model"].indexOf(e.target.name) != -1 )
								return true;
							
						});

						//console.log(linksUpdate);

						var y_coordinates_Link = [];

						linksUpdate.each(function(link)
						{
							link.apMean = (+new_media_link(link.id)).toFixed(4);
							medie["link-"+link.id] = (+new_media_link(link.id)).toFixed(4);

							link.value = medie["link-"+link.id]/media_link;
							if(!(link.value > 0))
							{
								link.value = 0.002;
							}
							//console.log(link);
							link.dy = (Math.min(link.target.dy/link.target.targetLinks.length, 
								  link.source.dy/link.source.sourceLinks.length))*link.value;
							if(link.dy <2)
							{
								link.dy = 2;
							}
							//console.log(link);
							y_coordinates_Link.push(link);

						});
						

						
						var selStop = d3.select("#indri");
						var selModel = d3.select("#krovetz");
						var selStem = d3.select("#bb2");
						var currentxStop =  d3.transform(selStop.attr("transform")).translate[0];
						var currentxModel =  d3.transform(selModel.attr("transform")).translate[0];
						var currentxStem =  d3.transform(selStem.attr("transform")).translate[0];



						var sameXNodesStop = d3.selectAll(".node").filter(function(e){
							
							if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxStop)
								return true;
							}) //d3.transform(sel.attr("transform")).translate[0];
						//console.log(prova);
						var sameXNodesModel = d3.selectAll(".node").filter(function(e){
							
							if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxModel)
								return true;
							}) 
						var sameXNodesStem = d3.selectAll(".node").filter(function(e){
							
							if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxStem)
								return true;
							}) 
						
						var y_coordinates_Stop = [];
						var y_coordinates_Model = [];
						var y_coordinates_Stem = [];

						

						sameXNodesStop.each(function(e){
							y_coordinates_Stop.push([e, e.y, e.dy, e.dx]);

						});
						sameXNodesModel.each(function(e){
							y_coordinates_Model.push([e, e.y, e.dy, e.dx]);

						});
						sameXNodesStem.each(function(e){
							y_coordinates_Stem.push([e, e.y, e.dy, e.dx]);

						});
						//console.log(y_coordinates);

						y_coordinates_Stop = y_coordinates_Stop.sort(Comparator);
						y_coordinates_Stem = y_coordinates_Stem.sort(Comparator);
						y_coordinates_Model = y_coordinates_Model.sort(Comparator);
						//console.log(y_coordinates);


						var ndyStop = 0;
						var ndyStem = 0;
						var ndyModel = 0;

						y_coordinates_Stop.forEach(function(nodeToMove)
						{
							d3.select("#"+nodeToMove[0].name)
									.transition()
									.duration(700)
									.attr("transform", "translate(" + currentxStop + "," + (this.y = ndyStop) + ")"
										)
									.selectAll(function() { return this.childNodes; })
									.filter('rect').attr("height", ""+nodeToMove[2])
									.attr("width", ""+nodeToMove[3])
									.select(function() { return this.parentNode})
									.selectAll(function() { return this.childNodes; })
									.filter('text').attr("y", +nodeToMove[2]/2);
									
							//console.log(prova);
							var sel = d3.select("#"+nodeToMove[0].name);
							//console.log(sel[0]);
							sel.each(function(d){
								d.y = ndyStop;
							});
							//sel[0][0].__data__.y = ndyStop;
							ndyStop = ndyStop+nodeToMove[2]+1;

						});

						y_coordinates_Stem.forEach(function(nodeToMove)
						{
							d3.select("#"+nodeToMove[0].name)
									.transition()
									.duration(700)
									.attr("transform", "translate(" + currentxStem + "," + (this.y = ndyStem) + ")"
										)
									.selectAll(function() { return this.childNodes; })
									.filter('rect').attr("height", ""+nodeToMove[2])
									.attr("width", ""+nodeToMove[3])
									.select(function() { return this.parentNode})
									.selectAll(function() { return this.childNodes; })
									.filter('text').attr("y", +nodeToMove[2]/2);
							var sel = d3.select("#"+nodeToMove[0].name);
							//console.log(sel[0]);
							sel.each(function(d){
								d.y = ndyStem;
							});
							//sel[0][0].__data__.y = ndyStem;
							ndyStem = ndyStem+nodeToMove[2]+1;

						});

						y_coordinates_Model.forEach(function(nodeToMove)
						{
							d3.select("#"+nodeToMove[0].name)
									.transition()
									.duration(700)
									.attr("transform", "translate(" + currentxModel + "," + (this.y = ndyModel) + ")"
										)
									.selectAll(function() { return this.childNodes; })
									.filter('rect').attr("height", ""+nodeToMove[2])
									.attr("width", ""+nodeToMove[3])
									.select(function() { return this.parentNode})
									.selectAll(function() { return this.childNodes; })
									.filter('text').attr("y", +nodeToMove[2]/2);
							var sel = d3.select("#"+nodeToMove[0].name);
							//console.log(sel[0]);

							sel.each(function(d){
								d.y = ndyModel;
							});

							//sel[0][0].__data__.y = ndyModel;
							ndyModel = ndyModel+nodeToMove[2]+1;

						});

						y_coordinates_Link.forEach(function(linkToResize){
							//console.log(linkToResize);
							d3.select("#link-"+linkToResize.id)
									.style("stroke-width", function(){ return Math.max(2,linkToResize.dy)});
							//console.log(linkToResize[0]);
						});
						
						sankey.relayout();
						link.transition().duration(700).attr("d", path);//.sort(function(a,b){return a.ty - b.ty;});

						var all_selected_nodes = d3.selectAll("[node-selected='1']")[0];
						var sel_model = [];
						var sel_stem = [];
						var sel_stop = [];
						var sel_ap = [];
						
						var names_selected_nodes = [];
						all_selected_nodes.forEach(function(d)
						{
							names_selected_nodes.push(d.parentNode.id);

							if(selected_model.indexOf(d.parentNode.id) != -1)
							{
								sel_model.push(paths[d.parentNode.id]);
							}
							else if(selected_stem.indexOf(d.parentNode.id) != -1)
							{
								sel_stem.push(paths[d.parentNode.id]);
							}
							else if(selected_stop.indexOf(d.parentNode.id) != -1)
							{
								//console.log(d.parentNode.id);
								//console.log(paths[d.parentNode.id]);
								sel_stop.push(paths[d.parentNode.id]);
							}
							else
							{
								sel_ap.push(paths[d.parentNode.id]);
							}
						});

						var union_model = _.union.apply(_, sel_model);
						var union_stop = _.union.apply(_, sel_stop);
						var union_stem = _.union.apply(_, sel_stem);
						var union_ap = _.union.apply(_, sel_ap);
						var union_test = [];
						
						if(union_model.length != 0)
						{
							union_test.push(union_model);
						}
						if(union_stop.length != 0)
						{
							union_test.push(union_stop);
						}
						if(union_stem.length != 0)
						{
							union_test.push(union_stem);
						}
						if(union_ap.length != 0)
						{
							union_test.push(union_ap);
						}

						var commons = _.intersection.apply(_, union_test);
						
						/*if(names_selected_nodes.length>2)
						{
							for(i=2;i<names_selected_nodes.length;i++)
							{
								commons = _.intersection(commons, paths[names_selected_nodes[i]])
							}

						}*/

						d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
						
						var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
							if(!isNaN(+d.name))
								return true;
						})[0];

						var commons2 = [];							
						commons.forEach(function(d,i)
						{	
							//console.log(systems[d].path[0]);
							var link1 = d3.select("#link-"+systems[d].path[0]);
							//console.log(link1.attr("class"));
							var link2 = d3.select("#link-"+systems[d].path[1]);
							var link3 = d3.select("#link-"+systems[d].path[2]);
							if(radioLinkVal() == "node-based")
							{
							
								if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
								{

									commons2.push(d);
									d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
									d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link2.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
									d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
								
								}
								else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
								{
									commons2.push(d);
									link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
									link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								}
							}								
							else
							{
								if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
								{
									//console.log(link1.attr("source"));
									commons2.push(d);
									link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
									link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								}
							}
						});

						//update color con la media
						if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
							update_link_color(commons2);


					}

				}
				
				else
				{
					components[type].forEach(function(name)
					{
						$('#'+name).removeClass('visible').addClass('invisible');
						$('#'+name).children('text').removeClass('visible').addClass('invisible');
						
						if(actualInvisibleNodes != undefined)
						{
							actualInvisibleNodes.push(name);
						}
					});
					
					d3.selectAll("path").attr("class", "link invisible");
					
					if(val2)
					{
						var firstName = components[type][0];

						var component = d3.select("#"+firstName).attr("component");
						//console.log(component);

						var nodeToEdit = d3.selectAll(".node")
						/*.filter(function(e)
						{
							if(e.component != component && e.component != undefined)
								return true;
						});*/

						nodeToEdit.each(function(node)
						{
							node.apMean = new_media(node.name).toFixed(4);
							medie[node.name] = +(new_media(node.name)).toFixed(4);
							if(components["stoplist"].indexOf(node.name) != -1)
							{
								node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stop;
								node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stop;
								if(node.height < 30)
								{
									node.height = 30;
								}
								else if(node.height > 182)
								{
									node.height = 182;
								}

								if(node.width < 9)
								{
									node.width = 9;
								}
								else if(node.width > 25)
								{
									node.width = 25;
								}
								node.dy = node.height;
								node.dx = node.width;
							}
							else if(components["stemmer"].indexOf(node.name) != -1)
							{
								node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stem;
								node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stem;
								if(node.height < 30)
								{
									node.height = 30;
								}
								else if(node.height > 182)
								{
									node.height = 182;
								}

								if(node.width < 9)
								{
									node.width = 9;
								}
								else if(node.width > 25)
								{
									node.width = 25;
								}
								node.dy = node.height;
								node.dx = node.width;
							}

							else if(components["model"].indexOf(node.name) != -1)
							{
								node.height = ((+node.apMean+0.0002).toFixed(4)*47)/max_media_modelli;
								node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_modelli;
								if(node.height < 30)
								{
									node.height = 30;
								}
								else if(node.height > 65)
								{
									node.height = 65;
								}

								if(node.width < 9)
								{
									node.width = 9;
								}
								else if(node.width > 25)
								{
									node.width = 25;
								}
								node.dy = node.height;
								node.dx = node.width;
							}
						});
						//console.log(nodeToPrint);
						var linksUpdate = d3.selectAll(".link").filter(function(e)
						{
							//console.log(e);
							if(components["stoplist"].indexOf(e.target.name) != -1 || components["stemmer"].indexOf(e.target.name) != -1 || components["model"].indexOf(e.target.name) != -1 )
								return true;
							
						});

						//console.log(linksUpdate);
						var y_coordinates_Link = [];

						linksUpdate.each(function(link)
						{
							link.apMean = (+new_media_link(link.id)).toFixed(4);
							medie["link-"+link.id] = (+new_media_link(link.id)).toFixed(4);

							link.value = medie["link-"+link.id]/media_link;
							if(!(link.value > 0))
							{
								link.value = 0.002;
							}
							link.dy = (Math.min(link.target.dy/link.target.targetLinks.length, 
									  link.source.dy/link.source.sourceLinks.length))*link.value;
									  
							if(link.dy <2)
							{
								link.dy = 2;
							}

							y_coordinates_Link.push(link);
						});

						

						var selStop = d3.select("#indri");
						var selModel = d3.select("#krovetz");
						var selStem = d3.select("#bb2");
						var currentxStop =  d3.transform(selStop.attr("transform")).translate[0];
						var currentxModel =  d3.transform(selModel.attr("transform")).translate[0];
						var currentxStem =  d3.transform(selStem.attr("transform")).translate[0];



						var sameXNodesStop = d3.selectAll(".node").filter(function(e){
							
							if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxStop)
								return true;
							}) //d3.transform(sel.attr("transform")).translate[0];
						//console.log(prova);
						var sameXNodesModel = d3.selectAll(".node").filter(function(e){
							
							if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxModel)
								return true;
							}) 
						var sameXNodesStem = d3.selectAll(".node").filter(function(e){
							
							if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxStem)
								return true;
							}) 
						
						var y_coordinates_Stop = [];
						var y_coordinates_Model = [];
						var y_coordinates_Stem = [];
						sameXNodesStop.each(function(e){
							y_coordinates_Stop.push([e, e.y, e.dy, e.dx]);

						});
						sameXNodesModel.each(function(e){
							y_coordinates_Model.push([e, e.y, e.dy, e.dx]);

						});
						sameXNodesStem.each(function(e){
							y_coordinates_Stem.push([e, e.y, e.dy, e.dx]);

						});
						//console.log(y_coordinates);

						y_coordinates_Stop = y_coordinates_Stop.sort(Comparator);
						y_coordinates_Stem = y_coordinates_Stem.sort(Comparator);
						y_coordinates_Model = y_coordinates_Model.sort(Comparator);
						//console.log(y_coordinates);

						var ndyStop = 0;
						var ndyStem = 0;
						var ndyModel = 0;

						y_coordinates_Stop.forEach(function(nodeToMove)
						{
							d3.select("#"+nodeToMove[0].name)
									.transition()
									.duration(700)
									.attr("transform", "translate(" + currentxStop + "," + (this.y = ndyStop) + ")"
										)
									.selectAll(function() { return this.childNodes; })
									.filter('rect').attr("height", ""+nodeToMove[2])
									.attr("width", ""+nodeToMove[3])
									.select(function() { return this.parentNode})
									.selectAll(function() { return this.childNodes; })
									.filter('text').attr("y", +nodeToMove[2]/2);
							var sel = d3.select("#"+nodeToMove[0].name);
							//console.log(sel[0]);
							sel.each(function(d){
								d.y = ndyStop;
							});
							//sel[0][0].__data__.y = ndyStop;
							ndyStop = ndyStop+nodeToMove[2]+1;

						});

						y_coordinates_Stem.forEach(function(nodeToMove)
						{
							d3.select("#"+nodeToMove[0].name)
									.transition()
									.duration(700)
									.attr("transform", "translate(" + currentxStem + "," + (this.y = ndyStem) + ")"
										)
									.selectAll(function() { return this.childNodes; })
									.filter('rect').attr("height", ""+nodeToMove[2])
									.attr("width", ""+nodeToMove[3])
									.select(function() { return this.parentNode})
									.selectAll(function() { return this.childNodes; })
									.filter('text').attr("y", +nodeToMove[2]/2);
							var sel = d3.select("#"+nodeToMove[0].name);
							//console.log(sel[0]);

							sel.each(function(d){
								d.y = ndyStem;
							});

							//sel[0][0].__data__.y = ndyStem;
							ndyStem = ndyStem+nodeToMove[2]+1;

						});

						y_coordinates_Model.forEach(function(nodeToMove)
						{
							d3.select("#"+nodeToMove[0].name)
									.transition()
									.duration(700)
									.attr("transform", "translate(" + currentxModel + "," + (this.y = ndyModel) + ")"
										)
									.selectAll(function() { return this.childNodes; })
									.filter('rect').attr("height", ""+nodeToMove[2])
									.attr("width", ""+nodeToMove[3])
									.select(function() { return this.parentNode})
									.selectAll(function() { return this.childNodes; })
									.filter('text').attr("y", +nodeToMove[2]/2);
							var sel = d3.select("#"+nodeToMove[0].name);
							//console.log(sel[0]);

							sel.each(function(d){
								d.y = ndyModel;
							});

							//sel[0][0].__data__.y = ndyModel;
							ndyModel = ndyModel+nodeToMove[2]+1;

						});


						y_coordinates_Link.forEach(function(linkToResize){
							//console.log(linkToResize);
							d3.select("#link-"+linkToResize.id)

							.style("stroke-width", function(){ return Math.max(2,linkToResize.dy)});

							//console.log(linkToResize[0]);
						});
						//sankey.layout(0);
						sankey.relayout();
						link.transition().duration(700).attr("d", path);//.sort(function(a,b){return a.ty - b.ty;});
					}
				}
			}

			function change_checkbox_value()
			{

					if (this.id === "checkbox_vis")
					{
						var name = $(this).val();
						//console.log(name);
						var typeC = $(this).parent().parent().attr('id');
						//console.log(typeC);
						//console.log(typeof typeC);

						var all_visible = d3.selectAll("g").filter(".visible");
						//var all_selected_nodes = d3.selectAll("[node-selected='1']")[0];
						if($(this).is(":checked")) 
						{	
							actualInvisibleNodes = actualInvisibleNodes.filter(function(item) { 
								return item !== name;
							});
							//console.log();
							var vis_model = [];
							var vis_stem = [];
							var vis_stop = [];
							if(components["model"].indexOf(name) != -1)
							{
								vis_model.push(paths[name]);
							}
							else if(components["stemmer"].indexOf(name) != -1)
							{
								vis_stem.push(paths[name]);
							}
							else if(components["stoplist"].indexOf(name) != -1)
							{
								vis_stop.push(paths[name]);
							}
							
							//console.log(all_visible[0]);
							all_visible[0].forEach(function(d)
							{
								if(selected_model.indexOf(d.id) != -1)
								{
									vis_model.push(paths[d.id]);
								}
								else if(selected_stem.indexOf(d.id) != -1)
								{
									vis_stem.push(paths[d.id]);
								}
								else if(selected_stop.indexOf(d.id) != -1)
								{
									vis_stop.push(paths[d.id]);
								}
							});

							//console.log(inv_model);
							//console.log(inv_stop);
							//console.log(inv_stem);

							var union_vis_model = _.union.apply(_, vis_model);
							var union_vis_stop = _.union.apply(_, vis_stop);
							var union_vis_stem = _.union.apply(_, vis_stem);
							var union_test = [];
							
							if(union_vis_model.length != 0)
							{
								union_test.push(union_vis_model);
							}
							if(union_vis_stop.length != 0)
							{
								union_test.push(union_vis_stop);
							}
							if(union_vis_stem.length != 0)
							{
								union_test.push(union_vis_stem);
							}
							//console.log(union_inv_stop);
							//console.log(union_test);
							if(union_test.length == 3)
							{
								var union_vis = _.union.apply(_, union_test);

								var commons_vis = _.intersection.apply(_, union_test);
							
								$('#'+name).removeClass('invisible').addClass('visible');
								$('#'+name).children('text').removeClass('invisible').addClass('visible');

								var systems_selected = paths[name];

								commons_vis.forEach(function(d,i)
								{	
									//console.log(systems[d].path[0]);
									$("#link-"+systems[d].path[0]).removeClass('invisible').addClass('visible');
									$("#link-"+systems[d].path[1]).removeClass('invisible').addClass('visible');
									$("#link-"+systems[d].path[2]).removeClass('invisible').addClass('visible');
								});
								//console.log(commons_vis);
								//update_link_color(commons_vis);
							}
							else
							{
								$('#'+name).removeClass('invisible').addClass('visible');
								$('#'+name).children('text').removeClass('invisible').addClass('visible');

							}


							// illuminazione dei path in base ai nodi selezionati

							var all_selected_nodes = d3.selectAll("[node-selected='1']")[0];
							var sel_model = [];
							var sel_stem = [];
							var sel_stop = [];
							var sel_ap = [];
							
							var names_selected_nodes = [];
							all_selected_nodes.forEach(function(d)
							{
								if(d.parentNode.classList[1] == "visible")
								{
									//console.log(d);
									names_selected_nodes.push(d.parentNode.id);

									if(selected_model.indexOf(d.parentNode.id) != -1)
									{
										sel_model.push(paths[d.parentNode.id]);
									}
									else if(selected_stem.indexOf(d.parentNode.id) != -1)
									{
										sel_stem.push(paths[d.parentNode.id]);
									}
									else if(selected_stop.indexOf(d.parentNode.id) != -1)
									{
										//console.log(d.parentNode.id);
										//console.log(paths[d.parentNode.id]);
										sel_stop.push(paths[d.parentNode.id]);
									}
									else
									{
										sel_ap.push(paths[d.parentNode.id]);
									}
								}	
							});

							var union_model = _.union.apply(_, sel_model);
							var union_stop = _.union.apply(_, sel_stop);
							var union_stem = _.union.apply(_, sel_stem);
							var union_ap = _.union.apply(_, sel_ap);
							var union_test = [];
							
							if(union_model.length != 0)
							{
								union_test.push(union_model);
							}
							if(union_stop.length != 0)
							{
								union_test.push(union_stop);
							}
							if(union_stem.length != 0)
							{
								union_test.push(union_stem);
							}
							if(union_ap.length != 0)
							{
								union_test.push(union_ap);
							}

							var commons = _.intersection.apply(_, union_test);
							
							/*if(names_selected_nodes.length>2)
							{
								for(i=2;i<names_selected_nodes.length;i++)
								{
									commons = _.intersection(commons, paths[names_selected_nodes[i]])
								}

							}*/

							d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
							
							var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
								if(!isNaN(+d.name))
									return true;
							})[0];

							var commons2 = [];							
							commons.forEach(function(d,i)
							{	
								//console.log(systems[d].path[0]);
								var link1 = d3.select("#link-"+systems[d].path[0]);
								//console.log(link1.attr("class"));
								var link2 = d3.select("#link-"+systems[d].path[1]);
								var link3 = d3.select("#link-"+systems[d].path[2]);
								if(radioLinkVal() == "node-based")
								{
								
									if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{

										commons2.push(d);
										d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
										d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link2.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
										d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
									
									}
									else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
								}								
								else
								{
									if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										//console.log(link1.attr("source"));
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
								}
							});

							//update color con la media
							if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
								update_link_color(commons2);
							

							//update_link_color(commons2);

							var component = d3.select("#"+name).attr("component");
							//console.log(component);

							var nodeToEdit = d3.selectAll(".node")
							/*.filter(function(e)
							{
								if(e.component != component && e.component != undefined)
								 return true;
							});*/

							nodeToEdit.each(function(node)
							{
								node.apMean = new_media(node.name).toFixed(4);
								medie[node.name] = +(new_media(node.name)).toFixed(4);
								if(components["stoplist"].indexOf(node.name) != -1)
								{
									node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stop;
									node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stop;
									if(node.height < 30)
									{
										node.height = 30;
									}
									else if(node.height > 182)
									{
										node.height = 182;
									}
									if(node.width < 9)
									{
										node.width = 9;
									}
									else if(node.width > 25)
									{
										node.width = 25;
									}
									node.dy = node.height;
									node.dx = node.width;
								}
								else if(components["stemmer"].indexOf(node.name) != -1)
								{
									node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stem;
									node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stem;
									if(node.height < 30)
									{
										node.height = 30;
									}
									else if(node.height > 182)
									{
										node.height = 182;
									}
	
									if(node.width < 9)
									{
										node.width = 9;
									}
									else if(node.width > 25)
									{
										node.width = 25;
									}
									node.dy = node.height;
									node.dx = node.width;
								}
	
								else if(components["model"].indexOf(node.name) != -1)
								{
									node.height = ((+node.apMean+0.0002).toFixed(4)*47)/max_media_modelli;
									node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_modelli;
									if(node.height < 30)
									{
										node.height = 30;
									}
									else if(node.height > 65)
									{
										node.height = 65;
									}
	
									if(node.width < 9)
									{
										node.width = 9;
									}
									else if(node.width > 25)
									{
										node.width = 25;
									}
									node.dy = node.height;
									node.dx = node.width;
								}
							})
							//console.log(nodeToPrint);
							var linksUpdate = d3.selectAll(".link").filter(function(e)
							{
								//console.log(e);
								if(components["stoplist"].indexOf(e.target.name) != -1 || components["stemmer"].indexOf(e.target.name) != -1 || components["model"].indexOf(e.target.name) != -1 )
								 	return true;
								
							});

							//console.log(linksUpdate);
							var y_coordinates_Link = [];


							linksUpdate.each(function(link)
							{
								link.apMean = (+new_media_link(link.id)).toFixed(4);
								medie["link-"+link.id] = (+new_media_link(link.id)).toFixed(4);

								link.value = medie["link-"+link.id]/media_link;
								if(!(link.value > 0))
								{
									link.value = 0.002;
								}
								link.dy = (Math.min(link.target.dy/link.target.targetLinks.length, 
											  link.source.dy/link.source.sourceLinks.length))*link.value;
								if(link.dy <2)
								{
									link.dy = 2;
								}

								y_coordinates_Link.push(link);
							});

							

							var selStop = d3.select("#indri");
							var selModel = d3.select("#krovetz");
							var selStem = d3.select("#bb2");
							var currentxStop =  d3.transform(selStop.attr("transform")).translate[0];
							var currentxModel =  d3.transform(selModel.attr("transform")).translate[0];
							var currentxStem =  d3.transform(selStem.attr("transform")).translate[0];



							var sameXNodesStop = d3.selectAll(".node").filter(function(e){
								
								if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxStop)
									return true;
								}) //d3.transform(sel.attr("transform")).translate[0];
							//console.log(prova);
							var sameXNodesModel = d3.selectAll(".node").filter(function(e){
								
								if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxModel)
									return true;
								}) 
							var sameXNodesStem = d3.selectAll(".node").filter(function(e){
								
								if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxStem)
									return true;
								}) 
							
							var y_coordinates_Stop = [];
							var y_coordinates_Model = [];
							var y_coordinates_Stem = [];
							sameXNodesStop.each(function(e){
								y_coordinates_Stop.push([e, e.y, e.dy, e.dx]);

							});
							sameXNodesModel.each(function(e){
								y_coordinates_Model.push([e, e.y, e.dy, e.dx]);

							});
							sameXNodesStem.each(function(e){
								y_coordinates_Stem.push([e, e.y, e.dy, e.dx]);

							});
							//console.log(y_coordinates);

							y_coordinates_Stop = y_coordinates_Stop.sort(Comparator);
							y_coordinates_Stem = y_coordinates_Stem.sort(Comparator);
							y_coordinates_Model = y_coordinates_Model.sort(Comparator);
							//console.log(y_coordinates);

							var ndyStop = 0;
							var ndyStem = 0;
							var ndyModel = 0;

							y_coordinates_Stop.forEach(function(nodeToMove)
							{
								d3.select("#"+nodeToMove[0].name)
										.transition()
										.duration(700)
										.attr("transform", "translate(" + currentxStop + "," + (this.y = ndyStop) + ")"
											)
										.selectAll(function() { return this.childNodes; })
										.filter('rect').attr("height", ""+nodeToMove[2])
										.attr("width", ""+nodeToMove[3])
										.select(function() { return this.parentNode})
										.selectAll(function() { return this.childNodes; })
										.filter('text').attr("y", +nodeToMove[2]/2);
								var sel = d3.select("#"+nodeToMove[0].name);
								//console.log(sel[0]);

								sel.each(function(d){
									d.y = ndyStop;
								});
								
								//sel[0][0].__data__.y = ndyStop;
								ndyStop = ndyStop+nodeToMove[2]+1;

							});

							y_coordinates_Stem.forEach(function(nodeToMove)
							{
								d3.select("#"+nodeToMove[0].name)
										.transition()
										.duration(700)
										.attr("transform", "translate(" + currentxStem + "," + (this.y = ndyStem) + ")"
											)
										.selectAll(function() { return this.childNodes; })
										.filter('rect').attr("height", ""+nodeToMove[2])
										.attr("width", ""+nodeToMove[3])
										.select(function() { return this.parentNode})
										.selectAll(function() { return this.childNodes; })
										.filter('text').attr("y", +nodeToMove[2]/2);
								var sel = d3.select("#"+nodeToMove[0].name);
								//console.log(sel[0]);

								sel.each(function(d){
									d.y = ndyStem;
								});
								
								//sel[0][0].__data__.y = ndyStem;
								ndyStem = ndyStem+nodeToMove[2]+1;

							});

							y_coordinates_Model.forEach(function(nodeToMove)
							{
								d3.select("#"+nodeToMove[0].name)
										.transition()
										.duration(700)
										.attr("transform", "translate(" + currentxModel + "," + (this.y = ndyModel) + ")"
											)
										.selectAll(function() { return this.childNodes; })
										.filter('rect').attr("height", ""+nodeToMove[2])
										.attr("width", ""+nodeToMove[3])
										.select(function() { return this.parentNode})
										.selectAll(function() { return this.childNodes; })
										.filter('text').attr("y", +nodeToMove[2]/2);
								var sel = d3.select("#"+nodeToMove[0].name);
								//console.log(sel[0]);

								sel.each(function(d){
									d.y = ndyModel;
								});
								
								//sel[0][0].__data__.y = ndyModel;
								ndyModel = ndyModel+nodeToMove[2]+1;

							});

							y_coordinates_Link.forEach(function(linkToResize){
								//console.log(linkToResize);
								d3.select("#link-"+linkToResize.id)

								.style("stroke-width", function(){ return Math.max(2,linkToResize.dy)});

								//console.log(linkToResize[0]);
							});
							//sankey.layout(0);
							sankey.relayout();
							link.transition().duration(700).attr("d", path);//.sort(function(a,b){return a.ty - b.ty;});

						}
						else
						{
							actualInvisibleNodes.push(name);
							
							$('#'+name).removeClass('visible').addClass('invisible');
							
							/*.children('rect')
										.css("filter", "brightness(100%)")
										.css("fill", function(e){
							*///						return e.color = color(name.replace(/ .*/, ""));
							/*						})
										.attr('node-selected', '0');
							*/
							$('#'+name).children('text').removeClass('visible').addClass('invisible');
							
							var component = d3.select('#'+name).attr('component');
							var list_of_components = [];

							d3.selectAll("[component='"+component+"']").filter("[class='node invisible']").each(function(comp)
							{
								list_of_components.push(comp.name);	
							});

							if(list_of_components.length == components[component].length)
							{
								d3.selectAll("path").attr("class", "link invisible");
							}

							var systems_selected = paths[name];

							var selected_nodes = d3.selectAll("[node-selected='1']")[0];
							//console.log(selected_nodes);
							//console.log(systems_selected);
							//console.log(selected_nodes[0]);
							var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
								if(!isNaN(+d.name))
									return true;
							})[0];	

							systems_selected.forEach(function(d,i)
							{	
								//console.log(systems[d].path[0]);
								
								$("#link-"+systems[d].path[0]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible').attr('selected', '0');
								$("#link-"+systems[d].path[1]).attr('selected', '0');
								$("#link-"+systems[d].path[2]).attr('selected', '0');
								
								var firstcomp = d3.select("[position='1']")[0][0].id,
									thirdcomp = d3.select("[position='3']")[0][0].id;

								if(typeC == firstcomp)
								{
									$('#link-'+systems[d].path[1]).css('stroke-opacity', .3).css('stroke', 'black');
									$('#link-'+systems[d].path[2]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
									
								}
								else if(typeC == thirdcomp)
								{
									$('#link-'+systems[d].path[1]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
									$('#link-'+systems[d].path[2]).css('stroke-opacity', .3).css('stroke', 'black');
								}
								else
								{
									$('#link-'+systems[d].path[1]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
									$('#link-'+systems[d].path[2]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
								}


							});
							//console.log(selected_nodes);

							if(selected_nodes.length == 1)
							{
								var names_selected_node = selected_nodes[0].parentNode.id;
								var systems_selected2 = paths[names_selected_node];
								var commons2 = [];

								systems_selected2.forEach(function(d,i)
								{	
									//console.log(systems[d].path[0]);
									var link1 = d3.select("#link-"+systems[d].path[0]);
									//console.log(link1.attr("class"));
									var link2 = d3.select("#link-"+systems[d].path[1]);
									var link3 = d3.select("#link-"+systems[d].path[2]);
									if(radioLinkVal() == "node-based")
									{
									
										if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
										{

											commons2.push(d);
											d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
											d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link2.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
											d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
										
										}
										else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
										{
											commons2.push(d);
											link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
											link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
											link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										}
									}								
									else
									{
										if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
										{
											//console.log(link1.attr("source"));
											commons2.push(d);
											link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
											link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
											link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										}
									}
								});

								//update color con la media
								if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
									update_link_color(commons2);

								/*systems_selected2.forEach(function(d,i)
								{
									var link1 = d3.select("#link-"+systems[d].path[0]);
									//console.log(link1.attr("class"));
									var link2 = d3.select("#link-"+systems[d].path[1]);
									var link3 = d3.select("#link-"+systems[d].path[2]);
									if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										commons2.push(d);
										d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1");
										d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1");
										d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1");
									}
								});
								//console.log(commons2);
								update_link_color(commons2); */

							}
							
							else
							{
								var sel_model = [];
								var sel_stem = [];
								var sel_stop = [];
								var sel_ap = [];
								
								var names_selected_nodes = [];
								selected_nodes.forEach(function(d)
								{
									if(d.parentNode.classList[1] == "visible")
									{
										names_selected_nodes.push(d.parentNode.id);

										if(components["model"].indexOf(d.parentNode.id) != -1)
										{
											sel_model.push(paths[d.parentNode.id]);
										}
										else if(components["stemmer"].indexOf(d.parentNode.id) != -1)
										{
											sel_stem.push(paths[d.parentNode.id]);
										}
										else if(components["stoplist"].indexOf(d.parentNode.id) != -1)
										{
											//console.log(d.parentNode.id);
											//console.log(paths[d.parentNode.id]);
											sel_stop.push(paths[d.parentNode.id]);
										}
										else
										{
											sel_ap.push(paths[d.parentNode.id]);
										}
									}
								});

								//console.log(sel_model, sel_stem, sel_stop, sel_ap, names_selected_nodes);

								var union_model = _.union.apply(_, sel_model);
								var union_stop = _.union.apply(_, sel_stop);
								var union_stem = _.union.apply(_, sel_stem);
								var union_ap = _.union.apply(_, sel_ap);
								var union_test = [];
								
								if(union_model.length != 0)
								{
									union_test.push(union_model);
								}
								if(union_stop.length != 0)
								{
									union_test.push(union_stop);
								}
								if(union_stem.length != 0)
								{
									union_test.push(union_stem);
								}
								if(union_ap.length != 0)
								{
									union_test.push(union_ap);
								}

								//console.log(union_test);

								var commons = _.intersection.apply(_, union_test);
								
								/*
								if(names_selected_nodes.length>2)
								{
									for(i=2;i<names_selected_nodes.length;i++)
									{
										commons = _.intersection(commons, paths[names_selected_nodes[i]])
									}

								}
								*/
								d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
								var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
									if(!isNaN(+d.name))
										return true;
									})[0];	
								var commons2 = [];						
								commons.forEach(function(d,i)
								{	
									//console.log(systems[d].path[0]);
									var link1 = d3.select("#link-"+systems[d].path[0]);
									//console.log(link1.attr("class"));
									var link2 = d3.select("#link-"+systems[d].path[1]);
									var link3 = d3.select("#link-"+systems[d].path[2]);
									if(radioLinkVal() == "node-based")
									{
									
										if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
										{

											commons2.push(d);
											d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
											d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link2.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
											d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
										
										}
										else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
										{
											commons2.push(d);
											link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
											link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
											link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										}
									}								
									else
									{
										if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
										{
											//console.log(link1.attr("source"));
											commons2.push(d);
											link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
											link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
											link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										}
									}
								});

								//update color con la media
								if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
									update_link_color(commons2);

							}

							var component = d3.select("#"+name).attr("component");
							//console.log(component);

							var nodeToEdit = d3.selectAll(".node")
							/*.filter(function(e)
							{
								if(e.component != component && e.component != undefined)
								 return true;
							});*/

							nodeToEdit.each(function(node)
							{
								newMedia = new_media(node.name).toFixed(4);
								node.apMean = newMedia;
								
								medie[node.name] = +(new_media(node.name)).toFixed(4);
								if(components["stoplist"].indexOf(node.name) != -1)
								{
									node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stop;
									node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stop;
									if(node.height < 30)
									{
										node.height = 30;
									}
									else if(node.height > 182)
									{
										node.height = 182;
									}
	
									if(node.width < 9)
									{
										node.width = 9;
									}
									else if(node.width > 25)
									{
										node.width = 25;
									}
									node.dy = node.height;
									node.dx = node.width;
								}
								else if(components["stemmer"].indexOf(node.name) != -1)
								{
									node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stem;
									node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stem;
									if(node.height < 30)
									{
										node.height = 30;
									}
									else if(node.height > 182)
									{
										node.height = 182;
									}
	
									if(node.width < 9)
									{
										node.width = 9;
									}
									else if(node.width > 25)
									{
										node.width = 25;
									}
									node.dy = node.height;
									node.dx = node.width;
								}
	
								else if(components["model"].indexOf(node.name) != -1)
								{
									node.height = ((+node.apMean+0.0002).toFixed(4)*47)/max_media_modelli;
									node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_modelli;
									if(node.height < 30)
									{
										node.height = 30;
									}
									else if(node.height > 65)
									{
										node.height = 65;
									}
	
									if(node.width < 9)
									{
										node.width = 9;
									}
									else if(node.width > 25)
									{
										node.width = 25;
									}
									node.dy = node.height;
									node.dx = node.width;
								}
							});

							var linksUpdate = d3.selectAll(".link").filter(function(e)
							{
								if(components["stoplist"].indexOf(e.target.name) != -1 || components["stemmer"].indexOf(e.target.name) != -1 || components["model"].indexOf(e.target.name) != -1 )
								 	return true;
								
							});

							//console.log(linksUpdate);
							var y_coordinates_Link = [];

							linksUpdate.each(function(link)
							{
								link.apMean = new_media_link(link.id).toFixed(4);
								medie["link-"+link.id] = +(new_media_link(link.id)).toFixed(4);

								link.value = medie["link-"+link.id]/media_link;
								if(!(link.value > 0))
								{
									link.value = 0.002;
								}

								//console.log(link);

								link.dy = (Math.min(link.target.dy/link.target.targetLinks.length, 
										  link.source.dy/link.source.sourceLinks.length))*link.value;
								if(link.dy <2)
								{
									link.dy = 2;
								}

								y_coordinates_Link.push(link);
							});
							

							var selStop = d3.select("#indri");
							var selModel = d3.select("#krovetz");
							var selStem = d3.select("#bb2");
							var currentxStop =  d3.transform(selStop.attr("transform")).translate[0];
							var currentxModel =  d3.transform(selModel.attr("transform")).translate[0];
							var currentxStem =  d3.transform(selStem.attr("transform")).translate[0];



							var sameXNodesStop = d3.selectAll(".node").filter(function(e){
								
								if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxStop)
									return true;
								}) //d3.transform(sel.attr("transform")).translate[0];
							//console.log(prova);
							var sameXNodesModel = d3.selectAll(".node").filter(function(e){
								
								if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxModel)
									return true;
								}) 
							var sameXNodesStem = d3.selectAll(".node").filter(function(e){
								
								if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxStem)
									return true;
								}) 
							
							var y_coordinates_Stop = [];
							var y_coordinates_Model = [];
							var y_coordinates_Stem = [];
							sameXNodesStop.each(function(e){
								y_coordinates_Stop.push([e, e.y, e.dy, e.dx]);

							});
							sameXNodesModel.each(function(e){
								y_coordinates_Model.push([e, e.y, e.dy, e.dx]);

							});
							sameXNodesStem.each(function(e){
								y_coordinates_Stem.push([e, e.y, e.dy, e.dx]);

							});
							//console.log(y_coordinates);

							y_coordinates_Stop = y_coordinates_Stop.sort(Comparator);
							y_coordinates_Stem = y_coordinates_Stem.sort(Comparator);
							y_coordinates_Model = y_coordinates_Model.sort(Comparator);
							//console.log(y_coordinates);

							var ndyStop = 0;
							var ndyStem = 0;
							var ndyModel = 0;

							y_coordinates_Stop.forEach(function(nodeToMove)
							{
								d3.select("#"+nodeToMove[0].name)
										.transition()
										.duration(700)
										.attr("transform", "translate(" + currentxStop + "," + (this.y = ndyStop) + ")"
											)
										.selectAll(function() { return this.childNodes; })
										.filter('rect').attr("height", ""+nodeToMove[2])
										.attr("width", ""+nodeToMove[3])
										.select(function() { return this.parentNode})
										.selectAll(function() { return this.childNodes; })
										.filter('text').attr("y", +nodeToMove[2]/2);

								var sel = d3.select("#"+nodeToMove[0].name);
								//console.log(sel[0]);

								sel.each(function(d){
									d.y = ndyStop;
								});
								
								//sel[0][0].__data__.y = ndyStop;
								ndyStop = ndyStop+nodeToMove[2]+1;

							});

							y_coordinates_Stem.forEach(function(nodeToMove)
							{
								d3.select("#"+nodeToMove[0].name)
										.transition()
										.duration(700)
										.attr("transform", "translate(" + currentxStem + "," + (this.y = ndyStem) + ")"
											)
										.selectAll(function() { return this.childNodes; })
										.filter('rect').attr("height", ""+nodeToMove[2])
										.attr("width", ""+nodeToMove[3])
										.select(function() { return this.parentNode})
										.selectAll(function() { return this.childNodes; })
										.filter('text').attr("y", +nodeToMove[2]/2);
								var sel = d3.select("#"+nodeToMove[0].name);
								//console.log(sel[0]);

								sel.each(function(d){
									d.y = ndyStem;
								});
								
								//sel[0][0].__data__.y = ndyStem;
								ndyStem = ndyStem+nodeToMove[2]+1;

							});

							y_coordinates_Model.forEach(function(nodeToMove)
							{
								d3.select("#"+nodeToMove[0].name)
										.transition()
										.duration(700)
										.attr("transform", "translate(" + currentxModel + "," + (this.y = ndyModel) + ")"
											)
										.selectAll(function() { return this.childNodes; })
										.filter('rect').attr("height", ""+nodeToMove[2])
										.attr("width", ""+nodeToMove[3])
										.select(function() { return this.parentNode})
										.selectAll(function() { return this.childNodes; })
										.filter('text').attr("y", +nodeToMove[2]/2);
								var sel = d3.select("#"+nodeToMove[0].name);
								//console.log(sel[0]);

								sel.each(function(d){
									d.y = ndyModel;
								});
								
								//sel[0][0].__data__.y = ndyModel;
								ndyModel = ndyModel+nodeToMove[2]+1;

							});

							y_coordinates_Link.forEach(function(linkToResize){
								//console.log(linkToResize);
								//var prova = d3.select("#link-"+linkToResize.id).style("stroke-width");;
								
								d3.select("#link-"+linkToResize.id)
								.style("stroke-width", function(){ return Math.max(2,linkToResize.dy)});
								//console.log(prova);
								//console.log(linkToResize[0]);
							});

							//sankey.layout(0);
							sankey.relayout();
							link.transition().duration(700).attr("d", path);//.sort(function(a,b){return a.ty - b.ty;});

							//new_media("krovetz");
						}
					}
					else
					{
						if($(this).is(":checked")) 
						{
							normalization(precision_active_nodes, precision_nodes, true);
							
						}
						else
						{
							normalization(precision_active_nodes, precision_nodes, false);
							

						}
						
					}
					
			}

			function change_checkbox_at_start(name)
			{
				//$('#'+name).removeClass('visible').addClass('invisible');
				
				/*.children('rect')
							.css("filter", "brightness(100%)")
							.css("fill", function(e){
				*///						return e.color = color(name.replace(/ .*/, ""));
				/*						})
							.attr('node-selected', '0');
				*/
				//$('#'+name).children('text').removeClass('visible').addClass('invisible');
				
				var component = d3.select('#'+name).attr('component');
				var list_of_components = [];
				var typeC = component;
				d3.selectAll("[component='"+component+"']").filter("[class='node invisible']").each(function(comp)
				{
					list_of_components.push(comp.name);	
				});

				if(list_of_components.length == components[component].length)
				{
					d3.selectAll("path").attr("class", "link invisible");
				}

				var systems_selected = paths[name];

				var selected_nodes = d3.selectAll("[node-selected='1']")[0];
				//console.log(selected_nodes);
				//console.log(systems_selected);
				//console.log(selected_nodes[0]);
				var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
					if(!isNaN(+d.name))
						return true;
				})[0];	

				systems_selected.forEach(function(d,i)
				{	
					//console.log(systems[d].path[0]);
					
					$("#link-"+systems[d].path[0]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible').attr('selected', '0');
					$("#link-"+systems[d].path[1]).attr('selected', '0');
					$("#link-"+systems[d].path[2]).attr('selected', '0');
					
					var firstcomp = d3.select("[position='1']")[0][0].id,
						thirdcomp = d3.select("[position='3']")[0][0].id;

					if(typeC == firstcomp)
					{
						$('#link-'+systems[d].path[1]).css('stroke-opacity', .3).css('stroke', 'black');
						$('#link-'+systems[d].path[2]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
						
					}
					else if(typeC == thirdcomp)
					{
						$('#link-'+systems[d].path[1]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
						$('#link-'+systems[d].path[2]).css('stroke-opacity', .3).css('stroke', 'black');
					}
					else
					{
						$('#link-'+systems[d].path[1]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
						$('#link-'+systems[d].path[2]).css('stroke-opacity', .3).css('stroke', 'black').removeClass('visible').addClass('invisible');
					}


				});
				//console.log(selected_nodes);

				if(selected_nodes.length == 1)
				{
					var names_selected_node = selected_nodes[0].parentNode.id;
					var systems_selected2 = paths[names_selected_node];
					var commons2 = [];

					systems_selected2.forEach(function(d,i)
					{	
						//console.log(systems[d].path[0]);
						var link1 = d3.select("#link-"+systems[d].path[0]);
						//console.log(link1.attr("class"));
						var link2 = d3.select("#link-"+systems[d].path[1]);
						var link3 = d3.select("#link-"+systems[d].path[2]);
						if(radioLinkVal() == "node-based")
						{
						
							if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
							{

								commons2.push(d);
								d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
								d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link2.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
								d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
							
							}
							else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
							{
								commons2.push(d);
								link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
								link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
							}
						}								
						else
						{
							if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
							{
								//console.log(link1.attr("source"));
								commons2.push(d);
								link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
								link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
							}
						}
					});

					//update color con la media
					if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
						update_link_color(commons2);

					/*systems_selected2.forEach(function(d,i)
					{
						var link1 = d3.select("#link-"+systems[d].path[0]);
						//console.log(link1.attr("class"));
						var link2 = d3.select("#link-"+systems[d].path[1]);
						var link3 = d3.select("#link-"+systems[d].path[2]);
						if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
						{
							commons2.push(d);
							d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1");
							d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1");
							d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1");
						}
					});
					//console.log(commons2);
					update_link_color(commons2); */

				}
				
				else
				{
					var sel_model = [];
					var sel_stem = [];
					var sel_stop = [];
					var sel_ap = [];
					
					var names_selected_nodes = [];
					selected_nodes.forEach(function(d)
					{
						if(d.parentNode.classList[1] == "visible")
						{
							names_selected_nodes.push(d.parentNode.id);

							if(components["model"].indexOf(d.parentNode.id) != -1)
							{
								sel_model.push(paths[d.parentNode.id]);
							}
							else if(components["stemmer"].indexOf(d.parentNode.id) != -1)
							{
								sel_stem.push(paths[d.parentNode.id]);
							}
							else if(components["stoplist"].indexOf(d.parentNode.id) != -1)
							{
								//console.log(d.parentNode.id);
								//console.log(paths[d.parentNode.id]);
								sel_stop.push(paths[d.parentNode.id]);
							}
							else
							{
								sel_ap.push(paths[d.parentNode.id]);
							}
						}
					});

					//console.log(sel_model, sel_stem, sel_stop, sel_ap, names_selected_nodes);

					var union_model = _.union.apply(_, sel_model);
					var union_stop = _.union.apply(_, sel_stop);
					var union_stem = _.union.apply(_, sel_stem);
					var union_ap = _.union.apply(_, sel_ap);
					var union_test = [];
					
					if(union_model.length != 0)
					{
						union_test.push(union_model);
					}
					if(union_stop.length != 0)
					{
						union_test.push(union_stop);
					}
					if(union_stem.length != 0)
					{
						union_test.push(union_stem);
					}
					if(union_ap.length != 0)
					{
						union_test.push(union_ap);
					}

					//console.log(union_test);

					var commons = _.intersection.apply(_, union_test);
					
					/*
					if(names_selected_nodes.length>2)
					{
						for(i=2;i<names_selected_nodes.length;i++)
						{
							commons = _.intersection(commons, paths[names_selected_nodes[i]])
						}

					}
					*/
					d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
					var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
						if(!isNaN(+d.name))
							return true;
						})[0];	
					var commons2 = [];						
					commons.forEach(function(d,i)
					{	
						//console.log(systems[d].path[0]);
						var link1 = d3.select("#link-"+systems[d].path[0]);
						//console.log(link1.attr("class"));
						var link2 = d3.select("#link-"+systems[d].path[1]);
						var link3 = d3.select("#link-"+systems[d].path[2]);
						if(radioLinkVal() == "node-based")
						{
						
							if(selected_nodes_measure.length == 0 && link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
							{

								commons2.push(d);
								d3.select("#link-"+systems[d].path[0]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link1.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
								d3.select("#link-"+systems[d].path[1]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link2.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
								d3.select("#link-"+systems[d].path[2]).style("stroke-opacity", ".3").style("stroke", ""+colorScheme[link3.attr("source")]).attr("selected","1"); // d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)))
							
							}
							else if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
							{
								commons2.push(d);
								link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
								link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
							}
						}								
						else
						{
							if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
							{
								//console.log(link1.attr("source"));
								commons2.push(d);
								link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
								link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
							}
						}
					});

					//update color con la media
					if(selected_nodes_measure.length != 0 || radioLinkVal() != "node-based")
						update_link_color(commons2);

				}

				var component = d3.select("#"+name).attr("component");
				//console.log(component);

				var nodeToEdit = d3.selectAll(".node")
				/*.filter(function(e)
				{
					if(e.component != component && e.component != undefined)
					 return true;
				});*/

				nodeToEdit.each(function(node)
				{
					newMedia = new_media(node.name).toFixed(4);
					node.apMean = newMedia;
					
					medie[node.name] = +(new_media(node.name)).toFixed(4);
					if(components["stoplist"].indexOf(node.name) != -1)
					{
						node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stop;
						node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stop;
						if(node.height < 30)
						{
							node.height = 30;
						}
						else if(node.height > 182)
						{
							node.height = 182;
						}

						if(node.width < 9)
						{
							node.width = 9;
						}
						else if(node.width > 25)
						{
							node.width = 25;
						}
						node.dy = node.height;
						node.dx = node.width;
					}
					else if(components["stemmer"].indexOf(node.name) != -1)
					{
						node.height = ((+node.apMean+0.0002).toFixed(4)*90)/max_media_stem;
						node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_stem;
						if(node.height < 30)
						{
							node.height = 30;
						}
						else if(node.height > 182)
						{
							node.height = 182;
						}

						if(node.width < 9)
						{
							node.width = 9;
						}
						else if(node.width > 25)
						{
							node.width = 25;
						}
						node.dy = node.height;
						node.dx = node.width;
					}

					else if(components["model"].indexOf(node.name) != -1)
					{
						node.height = ((+node.apMean+0.0002).toFixed(4)*47)/max_media_modelli;
						node.width = ((+node.apMean+0.0001).toFixed(4)*15)/max_media_modelli;
						if(node.height < 30)
						{
							node.height = 30;
						}
						else if(node.height > 65)
						{
							node.height = 65;
						}

						if(node.width < 9)
						{
							node.width = 9;
						}
						else if(node.width > 25)
						{
							node.width = 25;
						}
						node.dy = node.height;
						node.dx = node.width;
					}
				});

				var linksUpdate = d3.selectAll(".link").filter(function(e)
				{
					if(components["stoplist"].indexOf(e.target.name) != -1 || components["stemmer"].indexOf(e.target.name) != -1 || components["model"].indexOf(e.target.name) != -1 )
						 return true;
					
				});

				//console.log(linksUpdate);
				var y_coordinates_Link = [];

				linksUpdate.each(function(link)
				{
					link.apMean = new_media_link(link.id).toFixed(4);
					medie["link-"+link.id] = +(new_media_link(link.id)).toFixed(4);

					link.value = medie["link-"+link.id]/media_link;
					if(!(link.value > 0))
					{
						link.value = 0.002;
					}

					//console.log(link);

					link.dy = (Math.min(link.target.dy/link.target.targetLinks.length, 
							  link.source.dy/link.source.sourceLinks.length))*link.value;
					if(link.dy <2)
					{
						link.dy = 2;
					}

					y_coordinates_Link.push(link);
				});
				

				var selStop = d3.select("#indri");
				var selModel = d3.select("#krovetz");
				var selStem = d3.select("#bb2");
				var currentxStop =  d3.transform(selStop.attr("transform")).translate[0];
				var currentxModel =  d3.transform(selModel.attr("transform")).translate[0];
				var currentxStem =  d3.transform(selStem.attr("transform")).translate[0];



				var sameXNodesStop = d3.selectAll(".node").filter(function(e){
					
					if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxStop)
						return true;
					}) //d3.transform(sel.attr("transform")).translate[0];
				//console.log(prova);
				var sameXNodesModel = d3.selectAll(".node").filter(function(e){
					
					if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxModel)
						return true;
					}) 
				var sameXNodesStem = d3.selectAll(".node").filter(function(e){
					
					if(d3.transform(d3.select('[id="'+e.name+'"]').attr("transform")).translate[0] === currentxStem)
						return true;
					}) 
				
				var y_coordinates_Stop = [];
				var y_coordinates_Model = [];
				var y_coordinates_Stem = [];
				sameXNodesStop.each(function(e){
					y_coordinates_Stop.push([e, e.y, e.dy, e.dx]);

				});
				sameXNodesModel.each(function(e){
					y_coordinates_Model.push([e, e.y, e.dy, e.dx]);

				});
				sameXNodesStem.each(function(e){
					y_coordinates_Stem.push([e, e.y, e.dy, e.dx]);

				});
				//console.log(y_coordinates);

				y_coordinates_Stop = y_coordinates_Stop.sort(Comparator);
				y_coordinates_Stem = y_coordinates_Stem.sort(Comparator);
				y_coordinates_Model = y_coordinates_Model.sort(Comparator);
				//console.log(y_coordinates);

				var ndyStop = 0;
				var ndyStem = 0;
				var ndyModel = 0;

				y_coordinates_Stop.forEach(function(nodeToMove)
				{
					d3.select("#"+nodeToMove[0].name)
							.transition()
							.duration(700)
							.attr("transform", "translate(" + currentxStop + "," + (this.y = ndyStop) + ")"
								)
							.selectAll(function() { return this.childNodes; })
							.filter('rect').attr("height", ""+nodeToMove[2])
							.attr("width", ""+nodeToMove[3])
							.select(function() { return this.parentNode})
							.selectAll(function() { return this.childNodes; })
							.filter('text').attr("y", +nodeToMove[2]/2);

					var sel = d3.select("#"+nodeToMove[0].name);
					//console.log(sel[0]);

					sel.each(function(d){
						d.y = ndyStop;
					});
					
					//sel[0][0].__data__.y = ndyStop;
					ndyStop = ndyStop+nodeToMove[2]+1;

				});

				y_coordinates_Stem.forEach(function(nodeToMove)
				{
					d3.select("#"+nodeToMove[0].name)
							.transition()
							.duration(700)
							.attr("transform", "translate(" + currentxStem + "," + (this.y = ndyStem) + ")"
								)
							.selectAll(function() { return this.childNodes; })
							.filter('rect').attr("height", ""+nodeToMove[2])
							.attr("width", ""+nodeToMove[3])
							.select(function() { return this.parentNode})
							.selectAll(function() { return this.childNodes; })
							.filter('text').attr("y", +nodeToMove[2]/2);
					var sel = d3.select("#"+nodeToMove[0].name);
					//console.log(sel[0]);

					sel.each(function(d){
						d.y = ndyStem;
					});
					
					//sel[0][0].__data__.y = ndyStem;
					ndyStem = ndyStem+nodeToMove[2]+1;

				});

				y_coordinates_Model.forEach(function(nodeToMove)
				{
					d3.select("#"+nodeToMove[0].name)
							.transition()
							.duration(700)
							.attr("transform", "translate(" + currentxModel + "," + (this.y = ndyModel) + ")"
								)
							.selectAll(function() { return this.childNodes; })
							.filter('rect').attr("height", ""+nodeToMove[2])
							.attr("width", ""+nodeToMove[3])
							.select(function() { return this.parentNode})
							.selectAll(function() { return this.childNodes; })
							.filter('text').attr("y", +nodeToMove[2]/2);
					var sel = d3.select("#"+nodeToMove[0].name);
					//console.log(sel[0]);

					sel.each(function(d){
						d.y = ndyModel;
					});
					
					//sel[0][0].__data__.y = ndyModel;
					ndyModel = ndyModel+nodeToMove[2]+1;

				});

				y_coordinates_Link.forEach(function(linkToResize){
					//console.log(linkToResize);
					//var prova = d3.select("#link-"+linkToResize.id).style("stroke-width");;
					
					d3.select("#link-"+linkToResize.id)
					.style("stroke-width", function(){ return Math.max(2,linkToResize.dy)});
					//console.log(prova);
					//console.log(linkToResize[0]);
				});

				//sankey.layout(0);
				sankey.relayout();
				link.transition().duration(700).attr("d", path);//.sort(function(a,b){return a.ty - b.ty;});

			}
			
			

			//il codice seguente imposta la visibilità dei nodi
			//e dei link "online" in base alla selezione delle
			//checkbox
			$(function() {
				$(':checkbox').change(change_checkbox_value);
			});


			//se cambio topic devo generare il nuovo sankey
			$(function() {
				$("#topic").on("change", function()
				{
					$('#normalization input').each(function(){
						$(this).prop('checked', false);
					//console.log($(this).prop('checked', val));
					//console.log(this);
					});
					$('#Radio1').prop('checked', true);
					

					$('#Radio5').prop('checked', true);
					
					console.log("cambio topic");
					$('#chart').html('');
					//selectAll("stemmer", true, false);
					//selectAll("stoplist", true, false);
					//selectAll("model", true), false;
					show();				
					generateSankey();
					//hide();
					//setTimeout(hide, 3000);

				});
			});
			//se cambio collezione devo generare il nuovo sankey, devo inoltre cambiare
			//le opzioni topic selezionabili

			$(function() {
				$("#collection").on("change", function()
				{
					$('#normalization input').each(function(){
						$(this).prop('checked', false);
					//console.log($(this).prop('checked', val));
					//console.log(this);
					});
					$('#Radio1').prop('checked', true);
					

					$('#Radio5').prop('checked', true);

					$('#chart').html('');

					//var trec_selected = document.getElementById("collection");
					//var chosen_trec = trec_selected.options[trec_selected.selectedIndex].text;
					//var i = 1;
					topic_setup();

					if(radioval() == "average")
						$("#topic_form").removeClass("visible").addClass("invisible");
					else
						$("#topic_form").removeClass("invisible").addClass("visible");

					//selectAll("stemmer", true, false);
					//selectAll("stoplist", true, false);
					//selectAll("model", true, false);
					show();
					generateSankey();
					//setTimeout(hide, 3000);

				});
			});

			$(function() {

				$("#measure").on("change", function()
				{
					$('#normalization input').each(function(){
						$(this).prop('checked', false);
					//console.log($(this).prop('checked', val));
					//console.log(this);
					});
					$('#Radio1').prop('checked', true);
					

					$('#Radio5').prop('checked', true);

					var meas = selectedMeasure();

					if(radioval() == "average")
						$("#topic_form").removeClass("visible").addClass("invisible");
					else
						$("#topic_form").removeClass("invisible").addClass("visible");
					
					if(meas != "ndcg")
					{
						//$("#topic_form").removeClass("invisible").addClass("visible");
						$("#title4").html("<h4>"+ meas[0].toUpperCase() + meas.substring(1) + " Value</h4>");
						$('#chart').html('');
						show();
						//selectAll("stemmer", true, false);
						//selectAll("stoplist", true, false);
						//selectAll("model", true, false);
						show();
						generateSankey();

					}  
					else
					{
						//$("#topic_form").removeClass("invisible").addClass("visible");
						$("#title4").html("<h4>nDCG Value</h4>");
						$('#chart').html('');
						show();
						//selectAll("stemmer", true, false);
						//selectAll("stoplist", true, false);
						//selectAll("model", true, false);
						show();
						generateSankey();

					}   

				});

			});

			//gestione del cambio di stato dei due radio button
			// di valori ap e map.
			$(function() {
				$('#radiomeas input[type=radio]').change(function() {
					
					$('#normalization input').each(function(){
						$(this).prop('checked', false);
					});
					
					$('#Radio1').prop('checked', true);
					

					$('#Radio5').prop('checked', true);
					
					var meas = radioval();
					
					if(meas == "average")
					{
						$("#topic_form").removeClass("visible").addClass("invisible");
						//$("#title4").html("<h4>Map Value</h4>");
						$('#chart').html('');
						show();
						selectAll("stemmer", true, false);
						selectAll("stoplist", true, false);
						selectAll("model", true, false);
						actualInvisibleNodes = [];
						show();


						generateSankey();

					}
					else
					{
						$("#topic_form").removeClass("invisible").addClass("visible");
						//$("#title4").html("<h4>Ap Value</h4>");
						$('#chart').html('');
						show();
						selectAll("stemmer", true, false);
						selectAll("stoplist", true, false);
						selectAll("model", true, false);
						actualInvisibleNodes = [];
						show();
						generateSankey();

					}     
					
				});
			});


			$(function() {
				$('#linkColor input[type=radio]').change(function() {
					if(radioLinkVal() == "node-based")
					{
						
						var link_selected = d3.selectAll("[selected='1']")[0];
						
						//console.log(link_selected);
						//var link_selected_name = [];
						var selected_nodes_measure = d3.selectAll("[node-selected='1']").filter(function(d){
								if(!isNaN(+d.name))
									return true;
							})[0];	
						if(selected_nodes_measure.length > 0)
						{
							link_selected.forEach(function(d)
							{
								console.log(d);
								d3.select("#"+d.id).style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00)));

								//console.log(""+d.id+ " media: "+media);

							});
						}
						else
						{
							link_selected.forEach(function(d)
							{
								//console.log(d);
								//console.log(d3.select("#"+d.id));
								var link1 = d3.select("#"+d.id);
								//console.log(link1.attr("class"));
								d3.select("#"+d.id).style("stroke", ""+colorScheme[link1.attr("source")]);
							});

							
						}
					}
					else
					{
						var selected_nodes = d3.selectAll("[node-selected='1']")[0];

						if(selected_nodes.length == 1)
						{
							//d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");
							var names_selected_node = selected_nodes[0].parentNode.id;
							var systems_selected = paths[names_selected_node];
							var commons2 = [];
							systems_selected.forEach(function(d,i)
							{	
								//console.log(systems[d].path[0]);
								var link1 = d3.select("#link-"+systems[d].path[0]);
								//console.log(link1.attr("class"));
								var link2 = d3.select("#link-"+systems[d].path[1]);
								var link3 = d3.select("#link-"+systems[d].path[2]);
								
								if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
								{
									//console.log(link1.attr("source"));
									commons2.push(d);
									link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
									link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
								}
								
							});

							
							update_link_color(commons2);
						}
						else if(selected_nodes.length > 1)
						{
							var sel_model = [];
							var sel_stem = [];
							var sel_stop = [];
							var sel_ap = [];
							
							var names_selected_nodes = [];
							selected_nodes.forEach(function(d)
							{
								
								if(d3.select(d.parentNode).attr("class") != "node invisible")
								{
									names_selected_nodes.push(d.parentNode.id);

									if(selected_model.indexOf(d.parentNode.id) != -1)
									{
										sel_model.push(paths[d.parentNode.id]);
									}
									else if(selected_stem.indexOf(d.parentNode.id) != -1)
									{
										sel_stem.push(paths[d.parentNode.id]);
									}
									else if(selected_stop.indexOf(d.parentNode.id) != -1)
									{
										//console.log(d.parentNode.id);
										//console.log(paths[d.parentNode.id]);
										sel_stop.push(paths[d.parentNode.id]);
									}
									else
									{
										sel_ap.push(paths[d.parentNode.id]);
									}
								}
							});

							var union_model = _.union.apply(_, sel_model);
							var union_stop = _.union.apply(_, sel_stop);
							var union_stem = _.union.apply(_, sel_stem);
							var union_ap = _.union.apply(_, sel_ap);
							var union_test = [];
							
							if(union_model.length != 0)
							{
								union_test.push(union_model);
							}
							if(union_stop.length != 0)
							{
								union_test.push(union_stop);
							}
							if(union_stem.length != 0)
							{
								union_test.push(union_stem);
							}
							if(union_ap.length != 0)
							{
								union_test.push(union_ap);
							}

							var commons = _.intersection.apply(_, union_test);
							
							/*if(names_selected_nodes.length>2)
							{
								for(i=2;i<names_selected_nodes.length;i++)
								{
									commons = _.intersection(commons, paths[names_selected_nodes[i]])
								}

							}*/

							d3.selectAll("[selected='1']").style("stroke-opacity", ".2").style("stroke","black").attr("selected","0");

							var commons2 = [];							
							commons.forEach(function(d,i)
							{	
								//console.log(systems[d].path[0]);
								var link1 = d3.select("#link-"+systems[d].path[0]);
								//console.log(link1.attr("class"));
								var link2 = d3.select("#link-"+systems[d].path[1]);
								var link3 = d3.select("#link-"+systems[d].path[2]);
								
									if(link1.attr("class").indexOf("invisible") == -1 && link2.attr("class").indexOf("invisible") == -1 && link3.attr("class").indexOf("invisible") == -1)
									{
										//console.log(link1.attr("source"));
										commons2.push(d);
										link1.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //
										link2.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
										link3.style("stroke-opacity", ".3").style("stroke", d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))).attr("selected","1"); //d3.interpolateRdYlGn((+systems[d].apCluster).map(min_value, (max_value+0.04).toFixed(2), 0.00, 1.00))
									}
								
							});

							
							update_link_color(commons2);

						}

					}
					
				});	
			});

			$(function() {
				$('#curvature input[type=radio]').change(function() {
					
					
					var curv = radioCurveVal();
					
					if(curv == "curve")
					{
						
						path = sankey.link().curvature(0.5);

						sankey.relayout();
						link.transition().duration(700).attr("d", path);//.sort(function(a,b){return a.ty - b.ty;});

					}
					else
					{
						path = sankey.link().curvature(0.05);

						sankey.relayout();
						link.transition().duration(700).attr("d", path);//.sort(function(a,b){return a.ty - b.ty;});

					}     
					
				});
			});


			function new_media(node_name)
			{
				var sistemi = paths[node_name];

				//console.log(sistemi);

				var invisible_links = d3.selectAll('.link').filter('.invisible');

				invisible_links.each(function(d){

					sistemi = _.difference(sistemi, path_link["link-"+d.id])
					//console.log(d.id);
				})

				//console.log(sistemi);

				var prec_array = [];
				for(index = 0; index<sistemi.length; index++)
				{
					prec_array.push(systems[sistemi[index]].ap);
				}
				var media = ap_mean(prec_array);

				if(isNaN(media))
				{
					//console.log(node_name + " ERRORE Media: " +media);
					media = 0;
				}
				//console.log(media);

				return media;
				
			}

			function new_media_link(link_id)
			{
				var sistemi = path_link["link-"+link_id];

				//console.log(sistemi);

				var invisible_links = d3.selectAll('.link').filter('.invisible');

				invisible_links.each(function(d){

					sistemi = _.difference(sistemi, path_link["link-"+d.id])
					//console.log(d.id);
				})

				//console.log(sistemi);

				var prec_array = [];
				for(index = 0; index<sistemi.length; index++)
				{
					prec_array.push(systems[sistemi[index]].ap);
				}
				var media = ap_mean(prec_array);

				if(isNaN(media))
					media = 0;

				//console.log(media);

				return media;
				
			}

			function Comparator(a, b) {
				if (a[1] < b[1]) return -1;
				if (a[1] > b[1]) return 1;
				return 0;
			}

			function dunnett(component_name)
			{
				//var sistemi = paths[component_name];

				var invisible_links = d3.selectAll('.link').filter('.invisible');
				
				var sistemi = paths[component_name];
				
				invisible_links.each(function(d){

					sistemi = _.difference(sistemi, path_link["link-"+d.id])
					//console.log(d.id);
				});
				
				var k = sistemi.length;
				var degree = k*50 - k;
				
				//systems_selected.sort(compare);
				//console.log(systems_selected);
//				console.log(sistemi);

				var media; 
				d3.select("#"+component_name).each(function(d){
					media = d.apMean;
				});
//				console.log(media);
//				console.log(sistemi);
				sistemi = sistemi.sort(compare);
//				console.log(sistemi);
				var best_path = systems[sistemi[0]];
//				console.log(best_path);

			
				var sswithin = 0;
				sistemi.forEach(function(s)
				{
					sswithin += +systems[s].errvariation;
					//console.log(systems[s]);
					//console.log(ss1total);
					//console.log(ss2);
					//console.log(ss1among);
				});

				var mswithin = sswithin/((50*sistemi.length)-sistemi.length);
				
				//console.log("SStotal = "+sstotal);
				//console.log("SSamong = "+ssamong);
				console.log("SSwithin = "+sswithin);
				console.log("MSwithin = "+mswithin);
				var q;
				//console.log(qTable);
				qTable.filter(function(row)
				{
					//console.log(row);
					if(row.groups == k && row.df == degree)
						q = row.Qval1;
				});

				//q=5;
				console.log("q = " +q);
	//			console.log("MSwithin = "+mswithin);
				
				var dunnett_list = [];
				index1 = 1;
				var MDS = q * Math.sqrt(mswithin*2/50);

				console.log("MDS = " + MDS);
				//console.log("HSD1 = " + HSD1);
				for(index1; index1<sistemi.length; index1++)
				{
					
					var diff = Math.abs((+systems[sistemi[0]].ap) - (+systems[sistemi[index1]].ap));
					//var confidence_interval = 2.01*Math.sqrt(systems[sistemi[index1]].variance/50);	
					//console.log(diff);
					if(diff <= MDS)
					{
						dunnett_list.push(sistemi[index1]);
	//					console.log(systems[sistemi[index1]].components + " CI = "+(systems[sistemi[index1]].ap+" ± " + confidence_interval))
					}
				}
				return dunnett_list;

			}

			function dunnett_link(link_name)
			{
				//var sistemi = paths[component_name];

				var invisible_links = d3.selectAll('.link').filter('.invisible');
				
				var sistemi = path_link[link_name];
				
				invisible_links.each(function(d){

					sistemi = _.difference(sistemi, path_link["link-"+d.id])
					//console.log(d.id);
				});
				
				var k = sistemi.length;
				var degree = k*50 - k;
				
				//systems_selected.sort(compare);
				//console.log(systems_selected);
//				console.log(sistemi);

				var media; 
				d3.select("#"+link_name).each(function(d){
					media = d.apMean;
				});
//				console.log(media);
//				console.log(sistemi);
				sistemi = sistemi.sort(compare);
//				console.log(sistemi);
				var best_path = systems[sistemi[0]];
//				console.log(best_path);

			
				var sswithin = 0;
				sistemi.forEach(function(s)
				{
					sswithin += +systems[s].errvariation;
					//console.log(systems[s]);
					//console.log(ss1total);
					//console.log(ss2);
					//console.log(ss1among);
				});

				var mswithin = sswithin/((50*sistemi.length)-sistemi.length);
				
				//console.log("SStotal = "+sstotal);
				//console.log("SSamong = "+ssamong);
				console.log("SSwithin = "+sswithin);
				console.log("MSwithin = "+mswithin);
				var q;
				//console.log(qTable);
				qTable.filter(function(row)
				{
					//console.log(row);
					if(row.groups == k && row.df == degree)
						q = row.Qval1;
				});

				//q=5;
				console.log("q = " +q);
	//			console.log("MSwithin = "+mswithin);
				
				var dunnett_list = [];
				index1 = 1;
				var MDS = q * Math.sqrt(mswithin*2/50);

				console.log("MDS = " + MDS);
				//console.log("HSD1 = " + HSD1);
				for(index1; index1<sistemi.length; index1++)
				{
					
					var diff = Math.abs((+systems[sistemi[0]].ap) - (+systems[sistemi[index1]].ap));
					//var confidence_interval = 2.01*Math.sqrt(systems[sistemi[index1]].variance/50);	
					//console.log(diff);
					if(diff <= MDS)
					{
						dunnett_list.push(sistemi[index1]);
	//					console.log(systems[sistemi[index1]].components + " CI = "+(systems[sistemi[index1]].ap+" ± " + confidence_interval))
					}
				}
				return dunnett_list;

			}

			function compare(a,b) 
			{
				if (systems[a].ap > systems[b].ap)
					return -1;
				if (systems[a].ap < systems[b].ap)
					return 1;
				return 0;
			}

		</script>
	</body>
 </html>